---
title: "TSIRO Baseline Data Analysis"
author: "Stella Banino"
date: '2022-12-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(moderndive)
library(modelr)
library(haven)
library(purrr)
library(RM.weights) #used for FIES analysis
library(corrplot)
```

## Importing the data

```{r import}
setwd("C:/Users/scban/Documents/UVA/TSIROBaselineDataAnalysis")
tsiro_raw_data <- read_dta("TSIRO_baseline_public_gender.dta")
view(tsiro_raw_data)
```

## Gender breakdown

In this block, we're counting the number of men and women who are heads of household, spouses, and respondents to each module and figuring out which modules had more male respondents and which had more female respondents.

```{r learning a bit more about gender respondents}

head_sex_count_table <- tsiro_raw_data %>%
  group_by(head_sex)%>%
  count(head_sex)%>%
  rename(sex = head_sex, head_sex = n)
#view(head_sex_count_table)
  
spouse_sex_count_table <- tsiro_raw_data %>%
  group_by(spouse_sex)%>%
  count(spouse_sex)%>%
  rename(sex = spouse_sex, spouse_sex = n)
#view(spouse_sex_count_table)

b_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_b_respondent_sex)%>%
  count(mod_b_respondent_sex)%>%
  rename(sex = mod_b_respondent_sex, roster_respondent_sex = n)

d_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_d_respondent_sex)%>%
  count(mod_d_respondent_sex)%>%
  rename(sex = mod_d_respondent_sex, agriculture_respondent_sex = n)

e_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_e_respondent_sex)%>%
  count(mod_e_respondent_sex)%>%
  rename(sex = mod_e_respondent_sex, credit_respondent_sex = n)

f_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_f_respondent_sex)%>%
  count(mod_f_respondent_sex)%>%
  rename(sex = mod_f_respondent_sex, nat_resources_respondent_sex = n)

g_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_g_respondent_sex)%>%
  count(mod_g_respondent_sex)%>%
  rename(sex = mod_g_respondent_sex, energy_respondent_sex = n)

i_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_i_respondent_sex)%>%
  count(mod_i_respondent_sex)%>%
  rename(poverty_respondent_sex = n)

c_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_c_respondent_sex)%>%
  count(mod_c_respondent_sex)%>%
  rename(sex = mod_c_respondent_sex, health_respondent_sex = n)

c_wdd_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_c_wdd_respondent_sex)%>%
  count(mod_c_wdd_respondent_sex)%>%
  rename(sex = mod_c_wdd_respondent_sex, wdd_respondent_sex = n)

h_sex_count_table <- tsiro_raw_data %>%
  group_by(mod_h_respondent_sex)%>%
  count(mod_h_respondent_sex)%>%
  rename(sex = mod_h_respondent_sex, gender_respondent_sex = n)
#view(h_sex_count_table)


sex_count_table <- list(head_sex_count_table, spouse_sex_count_table, b_sex_count_table, d_sex_count_table, e_sex_count_table, f_sex_count_table, g_sex_count_table, c_sex_count_table, c_wdd_sex_count_table, h_sex_count_table)%>%
  reduce(full_join, by = "sex")%>%
  mutate(sex = toString(sex))%>%
  mutate(sex = ifelse(sex=="1", "M", sex))%>%
  mutate(sex = ifelse(sex=="2", "F", sex))%>%
  #There's 100% a cleaner way to do this
  replace(is.na(.), 0)%>%
  pivot_longer(cols = 2:11, names_to = "categories", values_to = "amount")%>%
  pivot_wider(names_from = sex, values_from = amount)%>%
  arrange(desc(F))

#view(sex_count_table)
```

## Breaking down and cleaning the dataset

Let's start by dividing the dataset into each separate module and making the sex columns easier to understand.

```{r}

tsiro_fm_data <- tsiro_raw_data%>%
  mutate_at(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), as.character)%>%
  mutate(across(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), str_replace, "1", "M"))%>%
  mutate(across(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), str_replace, "2", "F"))
#glimpse(tsiro_raw_data)


roster <- select(tsiro_fm_data, hhid_deid, head_sex,spouse_sex,region,hhsize:read_head, fokontany_deid)
agriculture <- select(tsiro_fm_data, hhid_deid, mod_d_respondent_sex, plots:nrm_pract_y)
credit <- select(tsiro_fm_data, hhid_deid, mod_e_respondent_sex, loan_ngo:assist_inputs)
resources <- select(tsiro_fm_data, hhid_deid, mod_f_respondent_sex, trees:threats_other_EN)
energy <- select(tsiro_fm_data, hhid_deid, mod_g_respondent_sex, fuel_sources:fuel_dist1_3)
poverty <- select(tsiro_fm_data, hhid_deid, mod_i_respondent_sex, tv:detergent, birth, children_5_18)
foodsec <- select(tsiro_fm_data, hhid_deid, mod_c_respondent_sex, mod_c_wdd_respondent_sex, fies_enough:mddw)
empower <- select(tsiro_fm_data, hhid_deid, head_sex,spouse_sex, mod_h_respondent_sex, partner:alone)

# view(roster)
# view(agriculture)
# view(credit)
# view(resources)
# view(energy)
# view(poverty)
# view(foodsec)
# view(empower)
```


#### Adding gender back into credit section

starting w some planning...(and thinking out loud in R markdown)

basically...

M+a1 = M

  I, a man, made this decision.  Possibly by myself and possibly with my wife.
  
M+a0 = not M

  I, a man, did not make this decision.  Possibilities: wife made this decision, decision wasn't made at all.
  
F+a1 = F

  I, a woman, made this decision.  Possibly by myself and possibly with my husband.
  
F+a0 = not F

  I, a woman, did not make this decision.  Possibilities: husband made this decision, decision wasn't made at all
  
M+b1 = F

  My spouse, theoretically a woman, made this decision.  Possibilities: I made it with her or she made it by herself.
  update: not necessarily a woman.  Need to double-check spouse's gender.
  
M+b0 = not F

  My spouse, theoretically a woman, did not make this decision.  Possibilities: I made it without her or neither of us made it.
  
F+b1 = M

F+b0 = not M

realizing this assumes every couple in the dataset is straight.  going to check real quick to make sure this is an assumption I can make.  update: it's not.  love that they've found love but darn it messes up my math.

after, I'm imagining each set of columns looking like:

did you borrow from x?

options: 1 (yes), 0 (no)

who made the decision to borrow from x?

options: "M", "F", "MF", "N", "S", "MS", "FS", "MFS", where N is no one and S is someone else (inside or outside household)

factor it by power of the woman in the decision? kinda hard to define, so no

who decided how to use money from x?

options: "M", "F", "MF", "N", "S", "MS", "FS", "MFS", where N is no one and S is someone else (inside or outside household)

etc. for each institution

ok how do I want to go about this?

Might be easiest to create a column M or 0, F or 0, S or 0, and then add them together.  Any still 0 will become N.

Don't bother w columns where the value is 0 - it doesn't provide info that isn't provided elsewhere.

change self to M, F, and 0.  change spouse to M, F, and 0.  change both other columns to S and 0.  concatenate all four into one column.

How to tackle the spouse column?

![scratchpad discrete math](IMG_6699.jpg)

```{r}
non_straight_households <- tsiro_fm_data%>%
  filter(head_sex == spouse_sex)
#view(non_straight_households)
#I consider myself an ally but...darnit.  the gays are messing up my math.
#let's check if they actually borrowed money - ie if I actually have to adjust the code.
non_straight_households_credit <- non_straight_households%>%
  select(mod_e_respondent_sex, loan_ngo:assist_inputs)
#view(non_straight_households_credit)
#ok one of the MM households borrowed from a friend and both spouses contributed to the decision.  I'll structure the code around this.
#I'll take all this out (the above stuff) later, just keeping it for reference now.

credit_gender <- credit %>%
#changes borrow_(institution)_y to say whether they did (1) or didn't (0) borrow from the institution.
  mutate(borrow_ngo_y = abs(replace_na(borrow_ngo_y, 1)-1), borrow_formal_y = abs(replace_na(borrow_formal_y, 1)-1), borrow_informal_y = abs(replace_na(borrow_informal_y, 1)-1), borrow_friend_y = abs(replace_na(borrow_friend_y, 1)-1), borrow_group_y = abs(replace_na(borrow_group_y, 1)-1), borrow_sav_y = abs(replace_na(borrow_sav_y, 1)-1))

#get ready for the world's longest pipe - I spent two days trying to find a way
#to avoid this, to no avail.
credit_gender_b <- tsiro_raw_data%>%
  select(head_sex, spouse_sex, mod_e_respondent_sex, loan_ngo:assist_inputs)%>%
  mutate(borrow_ngo_y = abs(replace_na(borrow_ngo_y, 1)-1),
         use_ngo_y = abs(replace_na(use_ngo_y, 1)-1),
         borrow_formal_y = abs(replace_na(borrow_formal_y, 1)-1), 
         use_formal_y = abs(replace_na(use_formal_y, 1)-1),
         borrow_informal_y = abs(replace_na(borrow_informal_y, 1)-1), 
         use_informal_y = abs(replace_na(use_informal_y, 1)-1),
         borrow_friend_y = abs(replace_na(borrow_friend_y, 1)-1), 
         use_friend_y = abs(replace_na(use_friend_y, 1)-1),
         borrow_group_y = abs(replace_na(borrow_group_y, 1)-1), 
         use_group_y = abs(replace_na(use_group_y, 1)-1),
         borrow_sav_y = abs(replace_na(borrow_sav_y, 1)-1),
         use_sav_y = abs(replace_na(use_sav_y, 1)-1))%>%
  # repeat starting here
  mutate(borrow_ngo_self = borrow_ngo_a*mod_e_respondent_sex, 
         borrow_ngo_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*borrow_ngo_b, 
         borrow_ngo_inside = borrow_ngo_c*3, 
         borrow_ngo_outside = borrow_ngo_d*4, .before = use_ngo)%>%
  mutate(across(c("borrow_ngo_self", "borrow_ngo_spouse", "borrow_ngo_inside",
        "borrow_ngo_outside"), as.character))%>%
  mutate_at(vars(borrow_ngo_self:borrow_ngo_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(borrow_ngo_self:borrow_ngo_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(borrow_ngo_self:borrow_ngo_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(borrow_ngo_self:borrow_ngo_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(borrow_ngo_self:borrow_ngo_outside), ~ str_replace(., "0", ""))%>%
  unite(borrow_ngo_gender, borrow_ngo_self, borrow_ngo_spouse, borrow_ngo_inside,
        borrow_ngo_outside, sep = "", na.rm = TRUE)%>%
  mutate(borrow_ngo_gender = sapply(lapply(strsplit(borrow_ngo_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(use_ngo_self = use_ngo_a*mod_e_respondent_sex, 
         use_ngo_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*use_ngo_b, 
         use_ngo_inside = use_ngo_c*3, 
         use_ngo_outside = use_ngo_d*4, .before = loan_informal)%>%
  mutate(across(c("use_ngo_self", "use_ngo_spouse", "use_ngo_inside",
        "use_ngo_outside"), as.character))%>%
  mutate_at(vars(use_ngo_self:use_ngo_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(use_ngo_self:use_ngo_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(use_ngo_self:use_ngo_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(use_ngo_self:use_ngo_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(use_ngo_self:use_ngo_outside), ~ str_replace(., "0", ""))%>%
  unite(use_ngo_gender, use_ngo_self, use_ngo_spouse, use_ngo_inside,
        use_ngo_outside, sep = "", na.rm = TRUE)%>%
  mutate(use_ngo_gender = sapply(lapply(strsplit(use_ngo_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(borrow_informal_self = borrow_informal_a*mod_e_respondent_sex, 
         borrow_informal_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*borrow_informal_b, 
         borrow_informal_inside = borrow_informal_c*3, 
         borrow_informal_outside = borrow_informal_d*4, .before = use_informal)%>%
  mutate(across(c("borrow_informal_self", "borrow_informal_spouse", "borrow_informal_inside",
        "borrow_informal_outside"), as.character))%>%
  mutate_at(vars(borrow_informal_self:borrow_informal_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(borrow_informal_self:borrow_informal_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(borrow_informal_self:borrow_informal_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(borrow_informal_self:borrow_informal_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(borrow_informal_self:borrow_informal_outside), ~ str_replace(., "0", ""))%>%
  unite(borrow_informal_gender, borrow_informal_self, borrow_informal_spouse, borrow_informal_inside,
        borrow_informal_outside, sep = "", na.rm = TRUE)%>%
  mutate(borrow_informal_gender = sapply(lapply(strsplit(borrow_informal_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(use_informal_self = use_informal_a*mod_e_respondent_sex, 
         use_informal_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*use_informal_b, 
         use_informal_inside = use_informal_c*3, 
         use_informal_outside = use_informal_d*4, .before = loan_formal)%>%
  mutate(across(c("use_informal_self", "use_informal_spouse", "use_informal_inside",
        "use_informal_outside"), as.character))%>%
  mutate_at(vars(use_informal_self:use_informal_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(use_informal_self:use_informal_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(use_informal_self:use_informal_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(use_informal_self:use_informal_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(use_informal_self:use_informal_outside), ~ str_replace(., "0", ""))%>%
  unite(use_informal_gender, use_informal_self, use_informal_spouse, use_informal_inside,
        use_informal_outside, sep = "", na.rm = TRUE)%>%
  mutate(use_informal_gender = sapply(lapply(strsplit(use_informal_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(borrow_formal_self = borrow_formal_a*mod_e_respondent_sex, 
         borrow_formal_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*borrow_formal_b, 
         borrow_formal_inside = borrow_formal_c*3, 
         borrow_formal_outside = borrow_formal_d*4, .before = use_formal)%>%
  mutate(across(c("borrow_formal_self", "borrow_formal_spouse", "borrow_formal_inside",
        "borrow_formal_outside"), as.character))%>%
  mutate_at(vars(borrow_formal_self:borrow_formal_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(borrow_formal_self:borrow_formal_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(borrow_formal_self:borrow_formal_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(borrow_formal_self:borrow_formal_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(borrow_formal_self:borrow_formal_outside), ~ str_replace(., "0", ""))%>%
  unite(borrow_formal_gender, borrow_formal_self, borrow_formal_spouse, borrow_formal_inside,
        borrow_formal_outside, sep = "", na.rm = TRUE)%>%
  mutate(borrow_formal_gender = sapply(lapply(strsplit(borrow_formal_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(use_formal_self = use_formal_a*mod_e_respondent_sex, 
         use_formal_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*use_formal_b, 
         use_formal_inside = use_formal_c*3, 
         use_formal_outside = use_formal_d*4, .before = loan_group)%>%
  mutate(across(c("use_formal_self", "use_formal_spouse", "use_formal_inside",
        "use_formal_outside"), as.character))%>%
  mutate_at(vars(use_formal_self:use_formal_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(use_formal_self:use_formal_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(use_formal_self:use_formal_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(use_formal_self:use_formal_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(use_formal_self:use_formal_outside), ~ str_replace(., "0", ""))%>%
  unite(use_formal_gender, use_formal_self, use_formal_spouse, use_formal_inside,
        use_formal_outside, sep = "", na.rm = TRUE)%>%
  mutate(use_formal_gender = sapply(lapply(strsplit(use_formal_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(borrow_group_self = borrow_group_a*mod_e_respondent_sex, 
         borrow_group_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*borrow_group_b, 
         borrow_group_inside = borrow_group_c*3, 
         borrow_group_outside = borrow_group_d*4, .before = use_group)%>%
  mutate(across(c("borrow_group_self", "borrow_group_spouse", "borrow_group_inside",
        "borrow_group_outside"), as.character))%>%
  mutate_at(vars(borrow_group_self:borrow_group_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(borrow_group_self:borrow_group_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(borrow_group_self:borrow_group_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(borrow_group_self:borrow_group_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(borrow_group_self:borrow_group_outside), ~ str_replace(., "0", ""))%>%
  unite(borrow_group_gender, borrow_group_self, borrow_group_spouse, borrow_group_inside,
        borrow_group_outside, sep = "", na.rm = TRUE)%>%
  mutate(borrow_group_gender = sapply(lapply(strsplit(borrow_group_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(use_group_self = use_group_a*mod_e_respondent_sex, 
         use_group_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*use_group_b, 
         use_group_inside = use_group_c*3, 
         use_group_outside = use_group_d*4, .before = loan_sav)%>%
  mutate(across(c("use_group_self", "use_group_spouse", "use_group_inside",
        "use_group_outside"), as.character))%>%
  mutate_at(vars(use_group_self:use_group_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(use_group_self:use_group_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(use_group_self:use_group_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(use_group_self:use_group_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(use_group_self:use_group_outside), ~ str_replace(., "0", ""))%>%
  unite(use_group_gender, use_group_self, use_group_spouse, use_group_inside,
        use_group_outside, sep = "", na.rm = TRUE)%>%
  mutate(use_group_gender = sapply(lapply(strsplit(use_group_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(borrow_sav_self = borrow_sav_a*mod_e_respondent_sex, 
         borrow_sav_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*borrow_sav_b, 
         borrow_sav_inside = borrow_sav_c*3, 
         borrow_sav_outside = borrow_sav_d*4, .before = loan_sav)%>%
  mutate(across(c("borrow_sav_self", "borrow_sav_spouse", "borrow_sav_inside",
        "borrow_sav_outside"), as.character))%>%
  mutate_at(vars(borrow_sav_self:borrow_sav_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(borrow_sav_self:borrow_sav_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(borrow_sav_self:borrow_sav_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(borrow_sav_self:borrow_sav_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(borrow_sav_self:borrow_sav_outside), ~ str_replace(., "0", ""))%>%
  unite(borrow_sav_gender, borrow_sav_self, borrow_sav_spouse, borrow_sav_inside,
        borrow_sav_outside, sep = "", na.rm = TRUE)%>%
  mutate(borrow_sav_gender = sapply(lapply(strsplit(borrow_sav_gender, NULL),
        sort), paste, collapse=""))%>%
  # repeat starting here
  mutate(use_sav_self = use_sav_a*mod_e_respondent_sex, 
         use_sav_spouse = abs(((head_sex+spouse_sex+mod_e_respondent_sex)%%2)-2)*use_sav_b, 
         use_sav_inside = use_sav_c*3, 
         use_sav_outside = use_sav_d*4, .before = group_ag)%>%
  mutate(across(c("use_sav_self", "use_sav_spouse", "use_sav_inside",
        "use_sav_outside"), as.character))%>%
  mutate_at(vars(use_sav_self:use_sav_outside), ~ str_replace(., "1", "M"))%>%
  mutate_at(vars(use_sav_self:use_sav_outside), ~ str_replace(., "2", "F"))%>%
  mutate_at(vars(use_sav_self:use_sav_outside), ~ str_replace(., "3", "I"))%>%
  mutate_at(vars(use_sav_self:use_sav_outside), ~ str_replace(., "4", "O"))%>%
  mutate_at(vars(use_sav_self:use_sav_outside), ~ str_replace(., "0", ""))%>%
  unite(use_sav_gender, use_sav_self, use_sav_spouse, use_sav_inside,
        use_sav_outside, sep = "", na.rm = TRUE)%>%
  mutate(use_sav_gender = sapply(lapply(strsplit(use_sav_gender, NULL),
        sort), paste, collapse=""))
 view(credit_gender_b)
 credit_gender_narrow <- credit_gender_b %>%
   select(head_sex:mod_e_respondent_sex, ends_with("gender"), ends_with("_y"), group_ag:assist_inputs)
 view(credit_gender_narrow)
 
 credit_gender_consolidated <- credit_gender_narrow%>%
   unite(decision_makers, ends_with("gender"), sep="")%>%
   mutate(female_decision_maker = ifelse(str_detect(decision_makers, "F"), 1, 0), male_decision_maker = ifelse(str_detect(decision_makers, "M"), 1, 0), .after = decision_makers)%>%
   view()
 
#summarize(credit_gender_consolidated, women = sum(female_decision_maker), men = sum(male_decision_maker))
#more female than male decision_makers, but the gap decreases when you take out single-gender households (below).

# credit_gender_consolidated%>%
#   filter((head_sex+spouse_sex)==3)%>%
#   summarize(sum(female_decision_maker), sum(male_decision_maker))

credit_gender_less_consolidated <- credit_gender_narrow %>%
   unite(decision_makers_borrow, ends_with("gender") & starts_with("borrow"), sep="")%>%
   unite(decision_makers_use, ends_with("gender") & starts_with("use"), sep="")%>%
   mutate(female_decision_maker_borrow = ifelse(str_detect(decision_makers_borrow, "F"), 1, 0),
          male_decision_maker_borrow = ifelse(str_detect(decision_makers_borrow, "M"), 1, 0),
          female_decision_maker_use = ifelse(str_detect(decision_makers_use, "F"), 1, 0),
          male_decision_maker_use = ifelse(str_detect(decision_makers_use, "M"), 1, 0),
          .after = decision_makers_use)%>%
   view()

# credit_gender_less_consolidated%>%
#   summarize(sum(female_decision_maker_borrow), sum(male_decision_maker_borrow), sum(female_decision_maker_use), sum(male_decision_maker_use))
# #more women have a say in how money is used than whether it is borrowed.

# credit_gender_less_consolidated%>%
#   filter((head_sex + spouse_sex) == 3)%>%
#   summarize(sum(female_decision_maker_borrow), sum(male_decision_maker_borrow), sum(female_decision_maker_use), sum(male_decision_maker_use))
# #once we reduce to two-gender households, gap shrinks and we see that while a
# #roughly equal number of men and women decide on whether to borrow, more women
# #(slightly) decide how it is spent.

credit_gender_narrow%>%
   filter((head_sex + spouse_sex) == 3, borrow_ngo_gender != "")%>%
  glimpse()%>%
   ggplot()+
   geom_bar(mapping = aes(borrow_ngo_gender))

credit_gender_narrow%>%
   filter((head_sex + spouse_sex) == 3, use_ngo_gender != "")%>%
  glimpse()%>%
   ggplot()+
   geom_bar(mapping = aes(use_ngo_gender))
   
```

#### Exploring the empowerment dataset

Okay so a problem coming up here is that in all my adjustments of "you or your partner" data into gender data, I'm assuming the respondent is either the head of household or their spouse, but I have proof in some cases that that assumption is not legitimate, so where else might it not be legitimate?

```{r}
#view(empower)
#glimpse(empower)
empower_real <- empower%>%
  drop_na(mod_h_respondent_sex)%>%
  arrange(desc(mod_h_respondent_sex), partner)%>%
  mutate(male_respondent = ifelse(mod_h_respondent_sex == "M", 1, 0))%>%
  mutate(male_potentially_present = alone + male_respondent)%>%
  filter(mod_h_respondent_sex == "F" | (spouse_sex == "F" & partner == 1))%>%
  arrange(head_sex, spouse_sex, partner)%>%
  view()
#Making sure there is a woman in the household whom the respondent is discussing.
#Filters out men responding who have no wives or whose partners' genders we don't
#know.
#Adds column indicating whether woman in household was speaking for herself with
#no one else present.



```

#### Views on the environment score

```{r}
# glimpse(resources)
resources_views <- resources%>%
  rename(protect = protect_label)%>%
  mutate(across(starts_with("protect_"), ~ .x - 3))
# formatting so operations are easier

resources_views <- resources_views %>%
  mutate(protect_avg = rowMeans(select(resources_views, starts_with("protect_")), na.rm = TRUE), .after = protect_med)%>%
  mutate(protect_sum = protect_avg*8)
# glimpse()
# Calculating priority indicator "Average score measuring the perceived
# importance of protecting nature and the environment".
# Asks about the importance of 8 ecosystem services relevant to this population.

resources_views <- resources_views %>%
  rename("threats_illegal_logging" = "threats_big_a",
         "threats_slash_burn" = "threats_big_b",
         "threats_poaching" = "threats_big_c",
         "threats_wildlife_trafficking" = "threats_big_d",
         "threats_seine_fishing" = "threats_big_e",
         "threats_fishing_other" = "threats_big_f",
         "threats_climate_change" = "threats_big_g",
         "threats_farming" = "threats_big_h",
         "threats_resource_use" = "threats_big_i")

resources_trees <- resources_views%>%
  mutate(trees_why_perm = ifelse((trees_why_a == 1 |
                                    trees_why_e == 1 |
                                    trees_why_f == 1 |
                                    trees_why_i == 1 |
                                    trees_why_j == 1), 1, 0),
         trees_why_cut = ifelse((trees_why_b == 1 |
                                   trees_why_c == 1 |
                                   trees_why_d == 1 |
                                   trees_why_g == 1 |
                                   trees_why_h == 1 |
                                   trees_why_b == 1), 1, 0), .after = trees_other_EN)


```

I want to look more at unsustainable resource use.  The toolkit says each activity should pick unsustainable practices to look at, so here's a list of what TSIRO collected that I think I could use:
collection of forest products
plans to clear land next year
cleared land last year

do you engage in this activity?
why?
how important is it to you?
how often do you do it?
has this changed over the past year (if so, why)?
perception of ecosystem status in the future? (could take this from threats data)
who makes decisions on engaging in the activity and who engages most in the activity can be disaggregated by gender

Primary indicator here is whether the households engage in the activity, other stuff is just for added context



#### Calculating FIES Percentage

```{r}
# view(foodsec)
#code modified from FAO Voices of the Hungry project report, attached.

foodsec_fies <- foodsec%>%
  mutate(fies_unw_avg = rowMeans(select(foodsec, starts_with("fies_")), na.rm = TRUE), .after = fies_day)
```

#### Calculating PPI

```{r}
view(poverty)

poverty_ppi <- poverty%>%
  mutate(soap_water = as.numeric(water == 1 & (detergent == 1 | detergent == 2)),
         soap_4k = as.numeric(soap > 4000))%>%
  mutate(ppi = (77)*1 + (-13)*food_1 + (-13)*tv + (-12)*food_2 + (-7)*food_3
					+ (-5)*clothes_1 + (-4)*linen_2 + (4)*food_5 + (-4)*clothes_2
					+ (4)*birth + (-4)*food_4 + (-3)*clothes_3
					+ (-3)*soap_water + (-3)*shoes + (2)*children_5_18 + (-2)*linen_1
					+ (-1)*soap_4k + (-1)*roofmat)%>%
  view()

summarise(poverty_ppi, across(everything(), ~ sum(is.na(.x))))

# I'm using children 5-18 as a stand-in for children 6-11 rn, but that's illegal
# technically.  Will I have to go through IRB review process just to get their
# age group?

```


## Creating narrow dataset

Okay first planning - what do I want in here, section by section?

#### roster

hhid_deid
spouse_sex
gender_hh_type

#### agriculture

hhid_deid
nrm_pract:nrm_pract_g

#### credit

#### resources_views

hhid_deid
mod_f_respondent_sex
trees_plant:trees_other_EN
land_kind_a           did you clear forest for cultivation
clear_where_a         plan to clear land for cultivation
clear_protect         plan to clear protected area
honey, mush, insects, fruits, meat, plants, woods, char, fish     how important are each of these to your livelihood
protect_water:loss_affect   importance of protecting each, have you lost resources, how were you affected?
threats:threat_big_i

#### energy

hhid_deid
starts_with(fuel_sources), starts_with(fuel_men), starts_with(fuel_women) what fuel sources do you use and who spends how much time gathering them

I'm going to want to sum fuel_men variables and fuel_women variables, but might do that after join.

#### poverty

If I could figure out how they calculated PPI from this that would be great

#### foodsec_fies

hhid_deid
fies_enough:fies_unw_avg        fies info
CSI         coping strategies index score
birth       has anyone given birth in this household
mddw        minimum dietary diversity - women

#### empower

hhid_deid 

```{r}
# glimpse(roster)
# glimpse(agriculture)
# glimpse(credit)
# glimpse(resources_views)
# glimpse(energy)
# glimpse(poverty)
# glimpse(foodsec)
# glimpse(empower_real)

roster_merge <- roster%>%
  select(hhid_deid, head_sex, spouse_sex, gender_hh_type, fokontany_deid)
agriculture_merge <- agriculture%>%
  select(hhid_deid, nrm_pract:nrm_pract_y)
credit_merge <- credit%>%
  select(hhid_deid, loan_ngo, loan_informal, loan_formal, loan_friend, loan_group, loan_sav, starts_with("member_"))
resources_merge <- resources_trees
# %>%
#   select(hhid_deid, mod_f_respondent_sex, trees_plant:trees_other_EN,
#          land_kind_a, land_kind_c, clear_where_a, clear_where_c, clear_protect, collect:fish_why, protect_water:loss_affect,
#          threats:threats_resource_use)
energy_merge <- energy%>%
  select(hhid_deid, starts_with("fuel_sources"), starts_with("fuel_men"), starts_with("fuel_women"))
poverty_merge <- poverty_ppi
foodsec_merge <- foodsec_fies%>%
  select(hhid_deid, fies_enough:fies_unw_avg, CSI, birth, mddw)
empower_merge <- empower_real%>%
  select(hhid_deid)#:land_name, hit_out:alone, male_potentially_present)

final <- reduce(list(roster_merge, agriculture_merge, credit_merge, resources_merge, energy_merge, poverty_merge, foodsec_merge, empower_merge), full_join, by = "hhid_deid")%>%
  # how many natural resource management practices is this household using?
  mutate(nrm_pract_sum = rowSums(select(narrow, nrm_pract_a:nrm_pract_y)), .after = nrm_pract_g)%>%
  # how many hours are men vs. women spending collecting fuel
  mutate(across(fuel_men_1:fuel_women_6), replace_na(0))%>%
  mutate(fuel_men_hours = rowSums(select(narrow, fuel_men_1:fuel_men_6), na.rm = TRUE), .after= fuel_women_6)%>%
  mutate(fuel_women_hours = rowSums(select(narrow, fuel_women_1:fuel_women_6), na.rm = TRUE), .after = fuel_men_hours)%>%
  # getting rid of all the intermediate or replaced variables.
  select(-nrm_pract, -fuel_men_1:fuel_women_6)%>%
  view()
```
## Analysis

#### Initial poking around

```{r}

final%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(protect_water:protect_avg, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(protect_water:protect_avg, names_to = "protect_resource", names_prefix = "protect_")%>%
  ggplot(aes(protect_resource, value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")

# this looks at average scores on a five-point scale.  What about just a blanket
# do you think this resource is important or not?

final%>%
  mutate(yn_protect_water = ifelse(protect_water > 0, 1, 0),
         yn_protect_air = ifelse(protect_water > 0, 1, 0),
         yn_protect_soil = ifelse(protect_water > 0, 1, 0),
         yn_protect_comm = ifelse(protect_water > 0, 1, 0),
         yn_protect_raw = ifelse(protect_water > 0, 1, 0),
         yn_protect_plants = ifelse(protect_water > 0, 1, 0),
         yn_protect_dis = ifelse(protect_water > 0, 1, 0),
         yn_protect_med = ifelse(protect_water > 0, 1, 0),
         .after = protect_avg)%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(yn_protect_water:yn_protect_med, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(yn_protect_air:yn_protect_med, names_to = "yn_protect_resource", names_prefix = "yn_protect_")%>%
  ggplot(aes(fct_rev(fct_reorder(yn_protect_resource, value)), value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")+
  scale_y_continuous(labels = scales::percent)+
  guides(x = guide_axis(angle = 45))+
  labs(title = "Percent of Men and Women who Believe Ecosystem Services are Important to Protect...",
       x = "Resource",
       y = "Percent")

final%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(threats_illegal_logging:threats_resource_use, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(threats_illegal_logging:threats_resource_use, names_to = "threat_type", names_prefix = "threats_")%>%
  ggplot(aes(fct_rev(fct_reorder(threat_type, value)), value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")+
  scale_y_continuous(labels = scales::percent)+
  guides(x = guide_axis(angle = 45))+
  labs(title = "Percent of Men and Women who Believe Their Ecosystem Is Threatened By...",
       x = "Threat Type",
       y = "Percent")

# The greatest gap seems to be concern over firewood.  Out of curiosity...
summarise(final, across(c(fuel_men_3, fuel_women_3), ~ (mean(.x, na.rm = TRUE))))
# On average, men spend VASTLY more time collecting firewood than women.  Maybe
# that's why they're more concerned about the impact of illegal logging.

final%>%
  mutate(loss = as.factor(loss))%>%
  ggplot(aes(protect_avg))+
  geom_density(aes(color = loss), size = 1)+
  scale_color_brewer(palette = "Paired")

final%>%
  drop_na(nrm_pract_sum)%>%
  mutate(nrm_pract_sum = as.factor(nrm_pract_sum))%>%
  ggplot(aes(protect_avg))+
  geom_density(aes(color = nrm_pract_sum))+
  facet_grid(cols = vars(nrm_pract_sum))

final%>%
  drop_na(nrm_pract_sum)%>%
  mutate(nrm_pract_sum = as.factor(nrm_pract_sum))%>%
  ggplot(aes(protect_avg))+
  geom_density(aes(color = nrm_pract_sum))+
  facet_grid(cols = vars(nrm_pract_sum))
  

```


hm.  This is the first time I've gotten a good look at the roster and I'm
looking through the gender hh type and noticing that it doesn't always align
with the recorded head_sex/spouse_sex.  Is the spouse not living at home?  Either
way, this adds another layer of difficulty to my assumption that I can figure out
the gender of a respondent's partner based on this data.  I might just have to
take out any data that required me to assume the gender of the respondent's partner -
or the presence of a partner at all.


Ok questions for 1/12 meeting:
- going to need child_6_11 to accurately calculate PPI.  Would that need IRB approval?  If so, that's not going to get to me in time.
- for any of the you or your partner stuff to be helpful, I think we need to know if they're the head of the household for two reasons:
1. we don't know their marital status/spouse of their partner unless we have that
  a. based on the numbers that less than 1% of HoH couples are same-sex I don't mind assuming all unknown spouses are straight, but for the credit section, I don't even know if they have a partner
2. in the empowerment section we do know whether they have a partner, but we're missing a crucial aspect of their decision making power if we don't know whether they're in the HoH couple.  If I answered the door, I would say I'm not on the deed, but that doesn't mean women have less power in my household, it just means I'm not in the HoH couple

#### looking for stuff that correlates with several unsustainable activities
```{r}

final_agriculture <- full_join(final, agriculture, by = "hhid_deid")

final_agriculture <- final_agriculture%>%
  mutate(across(c("clear_where_a", "clear_where_c", "land_kind_a", "land_kind_c"), ~replace_na(.,0)))%>%
  mutate(clear_any = clear_where_a+clear_where_c+land_kind_a+land_kind_c)%>%
  mutate(clear_any = ifelse(clear_any > 0, 1, 0))%>%
  view()

final_agriculture%>%
  group_by(clear_any)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(clear_any)))+
  geom_bar()+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
  filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  group_by(clear_any)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(clear_any)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
    filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  group_by(collect)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(collect)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
    filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  drop_na(loss)%>%
  group_by(loss)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(loss)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
    filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  drop_na(threats_big)%>%
  group_by(threats_big)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(threats_big)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
    filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  drop_na(ppi)%>%
  group_by(ppi)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(ppi)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

#obviously not the best chart type for this, but wildly, you can see which crop-
#growers tend to be more and less wealthy.  Cassava growers aren't doing so hot.


# I feel like I'm trying to get a sense of a forest by staring at the bark of a
# single tree.

```
#### Does loss of ecosystem services correlate with resource protection?  Positively or negatively?
```{r ignore all this I got distracted}
plot_allapply <- function(choices) {

   # convert to character
   choices <- as.character(choices)

   # split at comma and unlist
   choices_split <- unlist(strsplit(choices, ","))

   # convert back to factor and plot
   plot(as.factor(choices_split))
}
plot_allapply(data$letter)

final%>%
  ggplot(aes(loss, ))+
  geom_point()


```

#### trees

I'm really loving the irony that I used a platitude about not seeing the forest at the beginning of this pivot, and then that's ACTUALLY what I was missing

```{r}

final%>%
  drop_na(threats_illegal_logging, wood_access)%>%
  ggplot(aes(as_factor(wood_access), fill = as_factor(threats_illegal_logging)))+
  geom_bar(position = "fill")

final%>%
  group_by(wood_access)%>%
  summarise(mean(threats_illegal_logging, na.rm = TRUE))

#ANOVA significance tests
summary(lm(wood_access ~ threats_illegal_logging, data = final))
# correlation between whether they've had trouble getting wood and whether they think the environment is threatened by illegal logging 
summary(lm(wood ~ threats_illegal_logging, data = final))
# no correlation between how important wood is to their livelihood and whether they think the environment is threatened by illegal logging
summary(lm(trees_plant ~ threats_illegal_logging, data = final))
# positive correlation
summary(lm(trees_why_perm ~ threats_illegal_logging, data = final))
# positive correlation
summary(lm(trees_why_cut ~ threats_illegal_logging, data = final))
# no significant correlation
summary(lm(wood_access ~ clear_where_a, data = final))
# no significant correlation between difficulty collecting firewood and plans to clear forest
summary(lm(clear_where_a ~ threats_illegal_logging, data = final))
# absolutely no correlation between threat of illegal logging and plan to clear land

```
#### Corrplots
```{r}
correlations_final <- final%>%
  mutate(member_sum = rowSums(select(final, member_ag:member_other2), na.rm = TRUE), .after = member_other2)%>%
  select(nrm_pract_a:nrm_pract_g, member_ag:member_women)%>%
  replace(is.na(.), 0)%>%
  rename(nrm_soil_cover = nrm_pract_a,
         nrm_soil_fertility = nrm_pract_b,
         nrm_agroforestry = nrm_pract_c,
         nrm_fire_prevent = nrm_pract_d,
         nrm_water = nrm_pract_e,
         nrm_erosion_control = nrm_pract_f,
         nrm_watershed = nrm_pract_g)%>%
  view()

M <- cor(correlations_final)

testRes <- cor.mtest(correlations_final, conf.level = 0.95)

corrplot(M, method = 'number', p.mat = testRes$p, tl.cex = 0.5, insig = 'blank', pch.cex = 0.8, pch.col = 'grey20', number.cex = 0.5, diag = FALSE, type = 'lower', is.corr = FALSE)
# members of agriculture groups were more likely to engage in natural resource managment practices than those who aren't.


correlations_final2 <- final%>%
  select(nrm_pract_a:nrm_pract_g, protect_water:protect_med)%>%
  replace(is.na(.), 0)%>%
  rename(nrm_soil_cover = nrm_pract_a,
         nrm_soil_fertility = nrm_pract_b,
         nrm_agroforestry = nrm_pract_c,
         nrm_fire_prevent = nrm_pract_d,
         nrm_water = nrm_pract_e,
         nrm_erosion_control = nrm_pract_f,
         nrm_watershed = nrm_pract_g)%>%
  view()

M2 <- cor(correlations_final2)

testRes2 <- cor.mtest(correlations_final2, conf.level = 0.95)

r = rbind(c('protect_water', 'nrm_soil_cover', 'protect_med', 'nrm_watershed'),
          c('nrm_soil_cover', 'protect_water', 'nrm_watershed', 'protect_med'))

corrplot(M2, method = 'number', p.mat = testRes2$p, tl.cex = 0.5, insig = 'blank', pch.cex = 0.8, number.cex = 0.5, diag = FALSE, is.corr = FALSE)%>%
  corrRect(namesMat = r)


```

```{r}
final_gap <- final%>%
  group_by(fokontany_deid)%>%
  summarise(mean_gap = mean(protect_sum, na.rm = TRUE) - mean(nrm_pract_sum, na.rm = TRUE), mean_ppi = mean(ppi, na.rm = TRUE))

final_gap <- final%>%
  group_by(fokontany_deid)%>%
  summarise(mean_gap = mean(protect_sum, na.rm = TRUE) - mean(nrm_pract_sum, na.rm = TRUE), mean_ppi = mean(ppi, na.rm = TRUE))

summary(lm(mean_gap ~ mean_ppi, data = final_gap))

final_gap_hh <- final%>%
  mutate(gap = protect_sum - nrm_pract_sum - trees_plant)%>%
  drop_na(gap)

#define response variable
y <- final_gap_hh$gap

#define matrix of predictor variables
final_predict <- final_gap_hh%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("nrm"), -starts_with("protect"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

library(glmnet)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min
best_lambda

#produce plot of test MSE by lambda value
plot(cv_model) 


best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq





#define response variable
y <- final_gap_hh$threats

#define matrix of predictor variables
final_predict <- final_gap_hh%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("threat"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

library(glmnet)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min

#produce plot of test MSE by lambda value
plot(cv_model) 

best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq

```
#### Membership
```{r member of any group}
# adding membership info into the most recent dataset

final_member <- final_gap_hh%>%
  mutate(across(member_ag:member_other2, ~replace_na(.,0)))
final_member<- final_member%>%
  mutate(member_sum = rowSums(select(final_member, member_ag:member_other2)), .after = member_other2)%>%
  mutate(member_any = ifelse((member_sum>0), 1, 0))%>%
  mutate(threats_sum = rowSums(select()))

#define response variable
y <- final_member$member_any

#define matrix of predictor variables
final_predict <- final_member%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("member"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min

#produce plot of test MSE by lambda value
plot(cv_model) 

best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq


final_member <- final_member%>%
  mutate(threats_sum = rowSums(select(final_member, threats_illegal_logging:threats_resource_use), na.rm = TRUE), .after = threats_other_EN)%>%
  mutate(across(threats_illegal_logging:threats_resource_use, ~replace_na(., 0)))

final_member_compact <- final_member%>%
  select(member_sum, member_any, threats, threats_sum, protect_sum, nrm_pract_sum, trees_plant, loss, fies_unw_avg, mddw, ppi)%>%
  view()

final_member_compact %>%
  drop_na(.)%>%
  gather(threats, threats_sum, protect_sum, nrm_pract_sum, trees_plant, loss, fies_unw_avg, mddw, key = "var", value = "value") %>% 
  ggplot(aes(x = as_factor(member_any), fill = as_factor(value))) +
    geom_bar(position = 'fill') +
    facet_wrap(~ var, scales = "free") +
    theme_bw()

fact_names <- as_labeller(c("mddw" = "Women's minimum dietary diversity achieved", "trees_plant" = "Planted trees"))

final_member_compact %>%
  drop_na(.)%>%
  gather(mddw, trees_plant, key = "var", value = "value") %>% 
  ggplot(aes(x = as_factor(member_any), fill = as_factor(value))) +
    geom_bar(position = 'fill') +
    facet_wrap(~ var, scales = "free", labeller = fact_names) +
    scale_fill_brewer(palette = "Paired", name = "", labels = c("No", "Yes"))+
    labs(y = "Percent")+
    scale_y_continuous(labels = scales::percent)+
    theme_minimal()+
    scale_x_discrete(labels = c("Non-Member", "Member"), name = "")

final_member_compact%>%
  drop_na(ppi)%>%
  ggplot(aes(x = as_factor(member_any))) +
    geom_violin(aes(y = ppi))+
    geom_violin(aes(y = fies_unw_avg))+
    theme_bw()
  

summary(lm(threats ~ member_any, data = final_member))
summary(lm(threats_sum ~ member_any, data = final_member))
summary(lm(protect_sum ~ member_any, data = final_member))
summary(lm(nrm_pract_sum ~ member_any, data = final_member))
summary(lm(trees_plant ~ member_any, data = final_member))
#summary(lm(clear_where_a ~ member_any, data = final_member))
#summary(lm(clear_where_b ~ member_any, data = final_member))
#summary(lm(clear_where_c ~ member_any, data = final_member))
#summary(lm(clear_protect ~ member_any, data = final_member))
# the clear variables weren't as statistically significant as the rest (only one was significant at all)
summary(lm(loss ~ member_any, data = final_member))
summary(lm(fies_unw_avg ~ member_any, data = final_member))
summary(lm(ppi ~ member_any, data = final_member))
summary(lm(mddw ~ member_any, data = final_member))

final_member_predict <- final_member_compact%>%
  select(-member_sum, -threats_sum, -loss)%>%
  drop_na(ppi, mddw)

MM <- cor(final_member_predict)

testResM <- cor.mtest(final_member_predict, conf.level = 0.95)

view(MM)

rownames(MM) <- c("Whether they're a member of a group", "Believes environment is threatened", "How important they believe ecosystem services are", "How many natural resource management strategies they use", "Whether they've planted any trees recently", "How food insecure they are (FIES)", "Whether the women have achieved minimum dietary diversity (MDD-W)", "Probability they're in poverty (PPI)")
colnames(MM) <- c("Whether they're a member of a group", "Believes environment is threatened", "How important they believe ecosystem services are", "How many natural resource management strategies they use", "Whether they've planted any trees recently", "How food insecure they are (FIES)", "Whether the women have achieved minimum dietary diversity (MDD-W)", "Probability they're in poverty (PPI)")

corrplot(MM, method = 'color', p.mat = testResM$p, tl.cex = 0.5, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.8, number.cex = 0.5, diag = FALSE, is.corr = FALSE, type = 'lower', col = COL2('BrBG'), cl.pos = 'r', cl.cex = 0.3, tl.col = "black")


```

```{r are fokontanies with higher group membership similarly better off?}



```


```{r does the number of groups matter?}
#define response variable
y <- final_member$member_sum

#define matrix of predictor variables
final_predict <- final_member%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("member"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min

#produce plot of test MSE by lambda value
plot(cv_model) 

best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq

# nope.
```

#### Education
```{r}

#define response variable
final_ed <- final_member%>%
  full_join(roster, by = 'hhid_deid')%>%
  drop_na(ed_level_head)%>%
  select(nrm_pract_a:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, gap, ed_level_head)%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
y <- final_ed$ed_level_head

#define matrix of predictor variables
final_predict <- final_ed%>%
  select(-ed_level_head)

  
x <- data.matrix(final_predict)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min

#produce plot of test MSE by lambda value
plot(cv_model) 

best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq

# okay I could talk about this, but it isn't quite as interesting as membership.


final_ed <- final_member%>%
  mutate(threats_sum = rowSums(select(final_member, threats_illegal_logging:threats_resource_use), na.rm = TRUE), .after = threats_other_EN)%>%
  full_join(roster, by = 'hhid_deid')%>%
  drop_na(ed_level_head)%>%
  mutate(across(threats_illegal_logging:threats_resource_use, ~replace_na(., 0)))%>%
  view()

final_ed_compact <- final_ed%>%
  select(ed_level_head, member_sum, member_any, threats, threats_sum, protect_sum, nrm_pract_sum, trees_plant, clear_where_a, clear_where_b, clear_where_c, clear_protect, loss, fies_unw_avg, mddw, ppi)

final_ed_compact %>%
  drop_na(.)%>%
  gather(threats, threats_sum, protect_sum, nrm_pract_sum, trees_plant, clear_where_a, clear_where_b, clear_where_c, clear_protect, loss, fies_unw_avg, mddw, member_any, key = "var", value = "value") %>% 
  ggplot(aes(x = as_factor(ed_level_head), fill = as_factor(value))) +
    geom_bar(position = 'fill') +
    facet_wrap(~ var, scales = "free") +
    theme_bw()

final_ed_compact %>%
  drop_na(ppi)%>%
  ggplot(aes(x = as_factor(ed_level_head), fill = as_factor(ppi))) +
    geom_bar(position = 'fill') +
    theme_bw()

final_ed_compact %>%
  drop_na(ppi)%>%
  drop_na(ed_level_head)%>%
  ggplot(aes(x = as_factor(ed_level_head), y = ppi, fill = as_factor(ed_level_head))) +
    geom_boxplot() +
    guides(x = guide_axis(angle = 20), fill = "none")+
    labs(y = "Probability that a household is in poverty (PPI)", title = "Poverty Probabilities by Education Level of the Head of Household", x = "Education level of the head of household")


summary(lm(threats ~ ed_level_head, data = final_ed))
# + sig
# summary(lm(threats_sum ~ ed_level_head, data = final_ed))
# # + sig
# # fallen out of love with this one
summary(lm(protect_sum ~ ed_level_head, data = final_ed))
# + sig
summary(lm(nrm_pract_sum ~ ed_level_head, data = final_ed))
# + sig
summary(lm(trees_plant ~ ed_level_head, data = final_ed))
# + sig
# summary(lm(clear_where_a ~ ed_level_head, data = final_ed))
# # insig
# summary(lm(clear_where_b ~ ed_level_head, data = final_ed))
# # insig
# summary(lm(clear_where_c ~ ed_level_head, data = final_ed))
# # insig
# summary(lm(clear_protect ~ ed_level_head, data = final_ed))
# # insig
summary(lm(loss ~ ed_level_head, data = final_ed))
# + sig
# not sure how this adds to the story
summary(lm(fies_unw_avg ~ ed_level_head, data = final_ed))
# - sig
summary(lm(ppi ~ ed_level_head, data = final_ed))
# + sig
summary(lm(mddw ~ ed_level_head, data = final_ed))
# + sig


final_ed_predict <- final_ed_compact%>%
  select(-member_sum, -threats_sum, -clear_where_a, -clear_where_b, -clear_where_c, -clear_protect, -loss)%>%
  drop_na(ppi, mddw)%>%
  view()

ME <- cor(final_ed_predict)

testResEd <- cor.mtest(final_ed_predict, conf.level = 0.95)

view(ME)

rownames(ME) <- c("Education level of household head", "Whether they're a member of a group", "Believes environment is threatened", "How important they believe ecosystem services are", "How many natural resource management strategies they use", "Whether they've planted any trees recently", "How food insecure they are (FIES)", "Whether the women have achieved minimum dietary diversity (MDD-W)", "Probability they're in poverty (PPI)")
colnames(ME) <- c("Education level of household head", "Whether they're a member of a group", "Believes environment is threatened", "How important they believe ecosystem services are", "How many natural resource management strategies they use", "Whether they've planted any trees recently", "How food insecure they are (FIES)", "Whether the women have achieved minimum dietary diversity (MDD-W)", "Probability they're in poverty (PPI)")

corrplot(ME, method = 'color', p.mat = testResEd$p, tl.cex = 0.5, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.8, number.cex = 0.5, diag = FALSE, is.corr = FALSE, type = 'lower', col = COL2('BrBG'), cl.pos = 'r', cl.cex = 0.3, tl.col = "black")

```
#### Trees

okay last area

```{r}
final_trees <- final_member%>%
  select(member_forest, threats_illegal_logging, wood, wood_access, fuel_sources_3, clear_where_a, land_kind_a, nrm_pract_c, trees_plant)%>%
  replace(is.na(.), 0)%>%
  rename(nrm_agroforestry = nrm_pract_c)

MTree <- cor(final_trees)

testResTree <- cor.mtest(final_trees, conf.level = 0.95)

corrplot(MTree, method = 'color', p.mat = testResTree$p, tl.cex = 0.5, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.8, number.cex = 0.5, diag = FALSE, is.corr = FALSE)

```

## Miscellaneous Planning - it's old (pre-analysis), so don't worry about this part

Maybe try to incorporate in a gender empowerment index, based on SWPER but modified to this dataset?  Replace unavailable data w similar or similarly relevant data?

Would love to have biodiversity data - it would really add to this

Definitely incorporate score on how much they care about protecting the environment

Is it possible to make a sustainability index?  Should probably incorporate harmful activities (how much deforestation, weighted percentage of unclean fuel use, destructive agriculture practices) and helpful activities (reforestation, resource conservation, sustainably agriculture practices)

Is there a good poverty indicator?  Maybe ask Kelvin's advice on this

---
title: "TSIRO Baseline Data Analysis"
author: "Stella Banino"
date: '2022-12-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#install.packages('extrafont')

library(tidyverse)
library(moderndive)
library(modelr)
library(haven)
library(purrr)
library(corrplot)
library(extrafont)
library(glmnet)

```

## Importing the data

```{r import}
setwd("C:/Users/scban/Documents/UVA/TSIROBaselineDataAnalysis")
tsiro_raw_data <- read_dta("TSIRO_baseline_public_gender.dta")
view(tsiro_raw_data)
```


## Breaking down and cleaning the dataset

Let's start by dividing the dataset into each separate module and making the sex columns easier to understand.

```{r}

tsiro_fm_data <- tsiro_raw_data%>%
  mutate_at(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), as.character)%>%
  mutate(across(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), str_replace, "1", "M"))%>%
  mutate(across(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), str_replace, "2", "F"))
#glimpse(tsiro_raw_data)


roster <- select(tsiro_fm_data, hhid_deid, head_sex,spouse_sex,region,hhsize:read_head, fokontany_deid)
agriculture <- select(tsiro_fm_data, hhid_deid, mod_d_respondent_sex, plots:nrm_pract_y)
credit <- select(tsiro_fm_data, hhid_deid, mod_e_respondent_sex, loan_ngo:assist_inputs)
resources <- select(tsiro_fm_data, hhid_deid, mod_f_respondent_sex, trees:threats_other_EN)
energy <- select(tsiro_fm_data, hhid_deid, mod_g_respondent_sex, fuel_sources:fuel_dist1_3)
poverty <- select(tsiro_fm_data, hhid_deid, mod_i_respondent_sex, tv:detergent, birth, children_5_18)
foodsec <- select(tsiro_fm_data, hhid_deid, mod_c_respondent_sex, mod_c_wdd_respondent_sex, fies_enough:mddw)
empower <- select(tsiro_fm_data, hhid_deid, head_sex,spouse_sex, mod_h_respondent_sex, partner:alone)

# view(roster)
# view(agriculture)
# view(credit)
# view(resources)
# view(energy)
# view(poverty)
# view(foodsec)
# view(empower)
```


#### Transforming the resources section

One of the priority indicators is a sum of respondent's scores on how important they believe each resource is, so I created this as a variable.  I also renamed the threats to more memorable variable names.  I was curious whether households were planting trees with the intention of cutting them down or with the intention of leaving them standing for their ecosystem services.  Both would be better than not planting trees, but the latter could have a bigger impact on ecosystem health.  I created variables designating this. 

```{r}
# glimpse(resources)
resources_views <- resources%>%
  rename(protect = protect_label)%>%
  mutate(across(starts_with("protect_"), ~ .x - 3))
# formatting so operations are easier

resources_views <- resources_views %>%
  mutate(protect_avg = rowMeans(select(resources_views, starts_with("protect_")), na.rm = TRUE), .after = protect_med)%>%
  mutate(protect_sum = protect_avg*8)
# Calculating priority indicator "Average score measuring the perceived
# importance of protecting nature and the environment".
# Asks about the importance of 8 ecosystem services relevant to this population.

resources_views <- resources_views %>%
  rename("threats_illegal_logging" = "threats_big_a",
         "threats_slash_burn" = "threats_big_b",
         "threats_poaching" = "threats_big_c",
         "threats_wildlife_trafficking" = "threats_big_d",
         "threats_seine_fishing" = "threats_big_e",
         "threats_fishing_other" = "threats_big_f",
         "threats_climate_change" = "threats_big_g",
         "threats_farming" = "threats_big_h",
         "threats_resource_use" = "threats_big_i")

resources_trees <- resources_views%>%
  mutate(trees_why_perm = ifelse((trees_why_a == 1 |
                                    trees_why_e == 1 |
                                    trees_why_f == 1 |
                                    trees_why_i == 1 |
                                    trees_why_j == 1), 1, 0),
         trees_why_cut = ifelse((trees_why_b == 1 |
                                   trees_why_c == 1 |
                                   trees_why_d == 1 |
                                   trees_why_g == 1 |
                                   trees_why_h == 1 |
                                   trees_why_b == 1), 1, 0), .after = trees_other_EN)

```

#### Calculating FIES and PPI

FIES is the Food Insecurity Experience Scale.  It measures various indicators of food insecurity.  Each household's final score is calculated by summing how many of these boxes they check off.  For more information, reference the Voices of the Hungry project.

PPI is the Poverty Probability Index.  This index was developed by INRM for this data set.  It shows the probability each household is in poverty, based on a model developed with regression on recent Malagasy data.

```{r}
# view(foodsec)

foodsec_fies <- foodsec%>%
  mutate(fies_unw_avg = rowMeans(select(foodsec, starts_with("fies_")), na.rm = TRUE), .after = fies_day)

# view(poverty)

poverty_ppi <- poverty%>%
  mutate(soap_water = as.numeric(water == 1 & (detergent == 1 | detergent == 2)),
         soap_4k = as.numeric(soap > 4000))%>%
  mutate(ppi = (77)*1 + (-13)*food_1 + (-13)*tv + (-12)*food_2 + (-7)*food_3
					+ (-5)*clothes_1 + (-4)*linen_2 + (4)*food_5 + (-4)*clothes_2
					+ (4)*birth + (-4)*food_4 + (-3)*clothes_3
					+ (-3)*soap_water + (-3)*shoes + (2)*children_5_18 + (-2)*linen_1
					+ (-1)*soap_4k + (-1)*roofmat)

summarise(poverty_ppi, across(everything(), ~ sum(is.na(.x))))

```

## Creating narrow dataset

Once I explored each section, I chose a few variables from each to focus on for further analysis.  I merged these together here.

```{r}

roster_merge <- roster%>%
  select(hhid_deid, head_sex, spouse_sex, gender_hh_type:fokontany_deid)

agriculture_merge <- agriculture%>%
  select(hhid_deid, nrm_pract_a:nrm_pract_y)

credit_merge <- credit%>%
  select(hhid_deid, loan_ngo, loan_informal, loan_formal, loan_friend, loan_group, loan_sav, starts_with("member_"))

resources_merge <- resources_trees

energy_merge <- energy%>%
  select(hhid_deid, starts_with("fuel_sources"), starts_with("fuel_men"), starts_with("fuel_women"))

poverty_merge <- poverty_ppi%>%
  select(hhid_deid, ppi)

foodsec_merge <- foodsec_fies%>%
  select(hhid_deid, fies_enough:fies_unw_avg, CSI, birth, mddw)

final <- reduce(list(roster_merge, agriculture_merge, credit_merge, resources_merge, energy_merge, poverty_merge, foodsec_merge), full_join, by = "hhid_deid")%>%
  # how many natural resource management practices is this household using?
  mutate(nrm_pract_sum = rowSums(select(agriculture_merge, nrm_pract_a:nrm_pract_y)), .after = nrm_pract_g)%>%
  # how many hours are men vs. women spending collecting fuel
  mutate(across(fuel_men_1:fuel_women_6), replace_na(0))%>%
  mutate(fuel_men_hours = rowSums(select(energy_merge, fuel_men_1:fuel_men_6), na.rm = TRUE), .after= fuel_women_6)%>%
  mutate(fuel_women_hours = rowSums(select(energy_merge, fuel_women_1:fuel_women_6), na.rm = TRUE), .after = fuel_men_hours)

```

## Analysis

#### Creating USAID ggplot theme

Developed using USAID branding guidelines.

```{r}
theme_usaid <- function(){ 
    font <- "Gill Sans MT"
    theme_classic() %+replace%
    theme(
      #grid elements
      panel.grid.major = element_line(),
      plot.margin = margin(1, 1, 1, 1, "cm"),
      aspect.ratio = .9,
      #text elements
      plot.title = element_text(family = font, size = 16, hjust = 0, vjust = 1),
      axis.title = element_text(family = font, size = 12),
      axis.text = element_text(family = font, size = 12),
      axis.text.x = element_text(margin=margin(5, b = 10)),
      legend.text=element_text(family = font, size = 12)
    )
}

```

#### Initial exploration of correlations with environmental beliefs

The gender perspective didn't make it into the final article, but the focus on environmental beliefs did.  Later in this code chunk, I began exploring correlations with environmental experience.

```{r}

# I started with an exploration of the views on importance of different environmental resources.

final%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(protect_water:protect_avg, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(protect_water:protect_avg, names_to = "protect_resource", names_prefix = "protect_")%>%
  ggplot(aes(protect_resource, value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")

# this looks at average scores on a five-point scale.  What about just a blanket
# do you think this resource is important or not?

final%>%
  mutate(yn_protect_water = ifelse(protect_water > 0, 1, 0),
         yn_protect_air = ifelse(protect_water > 0, 1, 0),
         yn_protect_soil = ifelse(protect_water > 0, 1, 0),
         yn_protect_comm = ifelse(protect_water > 0, 1, 0),
         yn_protect_raw = ifelse(protect_water > 0, 1, 0),
         yn_protect_plants = ifelse(protect_water > 0, 1, 0),
         yn_protect_dis = ifelse(protect_water > 0, 1, 0),
         yn_protect_med = ifelse(protect_water > 0, 1, 0),
         .after = protect_avg)%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(yn_protect_water:yn_protect_med, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(yn_protect_air:yn_protect_med, names_to = "yn_protect_resource", names_prefix = "yn_protect_")%>%
  ggplot(aes(fct_rev(fct_reorder(yn_protect_resource, value)), value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")+
  scale_y_continuous(labels = scales::percent)+
  guides(x = guide_axis(angle = 45))+
  labs(title = "Percent of Men and Women who Believe Ecosystem Services are Important to Protect...",
       x = "Resource",
       y = "Percent")

# next in environmental views - perceptions of threats to ecosystem.

final%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(threats_illegal_logging:threats_resource_use, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(threats_illegal_logging:threats_resource_use, names_to = "threat_type", names_prefix = "threats_")%>%
  ggplot(aes(fct_rev(fct_reorder(threat_type, value)), value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")+
  scale_y_continuous(labels = scales::percent)+
  guides(x = guide_axis(angle = 45))+
  labs(title = "Percent of Men and Women who Believe Their Ecosystem Is Threatened By...",
       x = "Threat Type",
       y = "Percent")

# The greatest gap seems to be concern over firewood.  Out of curiosity...
summarise(final, across(c(fuel_men_3, fuel_women_3), ~ (mean(.x, na.rm = TRUE))))
# On average, men spend VASTLY more time collecting firewood than women.  Maybe
# that's why they're more concerned about the impact of illegal logging.


#That got me thinking - how does experience of ecosystem loss affect environmental beliefs?

final%>%
  mutate(loss = as.factor(loss))%>%
  ggplot(aes(protect_avg))+
  geom_density(aes(color = loss), size = 1)+
  scale_color_brewer(palette = "Paired")

# what about the positive experience of using natural resource management practices?

final%>%
  drop_na(nrm_pract_sum)%>%
  mutate(nrm_pract_sum = as.factor(nrm_pract_sum))%>%
  ggplot(aes(protect_avg))+
  geom_density(aes(color = nrm_pract_sum))+
  facet_grid(cols = vars(nrm_pract_sum))

```

#### Trees?

I considered theming my article around trees.  While I didn't go in that direction, it did help me sort out the forestry-related variables.

```{r}

final%>%
  drop_na(threats_illegal_logging, wood_access)%>%
  ggplot(aes(as_factor(wood_access), fill = as_factor(threats_illegal_logging)))+
  geom_bar(position = "fill")

final%>%
  group_by(wood_access)%>%
  summarise(mean(threats_illegal_logging, na.rm = TRUE))

# significance tests

summary(lm(wood_access ~ threats_illegal_logging, data = final))
# correlation between whether they've had trouble getting wood and whether they think the environment is threatened by illegal logging 
summary(lm(wood ~ threats_illegal_logging, data = final))
# no correlation between how important wood is to their livelihood and whether they think the environment is threatened by illegal logging
summary(lm(trees_plant ~ threats_illegal_logging, data = final))
# positive correlation
summary(lm(trees_why_perm ~ threats_illegal_logging, data = final))
# positive correlation
summary(lm(trees_why_cut ~ threats_illegal_logging, data = final))
# no significant correlation
summary(lm(wood_access ~ clear_where_a, data = final))
# no significant correlation between difficulty collecting firewood and plans to clear forest
summary(lm(clear_where_a ~ threats_illegal_logging, data = final))
# absolutely no correlation between threat of illegal logging and plan to clear land

```

#### Corrplots

Coming up empty, I made a ton of corrplots to try to find some significant correlations.

```{r}

# group membership vs. natural resource management practices - ended up informing the article

correlations_final <- final%>%
  mutate(member_sum = rowSums(select(final, member_ag:member_other2), na.rm = TRUE), .after = member_other2)%>%
  select(nrm_pract_a:nrm_pract_g, member_ag:member_women)%>%
  replace(is.na(.), 0)%>%
  rename(nrm_soil_cover = nrm_pract_a,
         nrm_soil_fertility = nrm_pract_b,
         nrm_agroforestry = nrm_pract_c,
         nrm_fire_prevent = nrm_pract_d,
         nrm_water = nrm_pract_e,
         nrm_erosion_control = nrm_pract_f,
         nrm_watershed = nrm_pract_g)%>%
  view()

M <- cor(correlations_final)

testRes <- cor.mtest(correlations_final, conf.level = 0.95)

corrplot(M, method = 'number', p.mat = testRes$p, tl.cex = 0.5, insig = 'blank', pch.cex = 0.8, pch.col = 'grey20', number.cex = 0.5, diag = FALSE, type = 'lower', is.corr = FALSE)
# members of agriculture groups were more likely to engage in natural resource managment practices than those who aren't.


# natural resource management practices vs. views.  I didn't find the strong correlation between specific resource types that I was hoping for, but there was a broader beliefs-action correlation explored more later.

correlations_final2 <- final%>%
  select(nrm_pract_a:nrm_pract_g, protect_water:protect_med)%>%
  replace(is.na(.), 0)%>%
  rename(nrm_soil_cover = nrm_pract_a,
         nrm_soil_fertility = nrm_pract_b,
         nrm_agroforestry = nrm_pract_c,
         nrm_fire_prevent = nrm_pract_d,
         nrm_water = nrm_pract_e,
         nrm_erosion_control = nrm_pract_f,
         nrm_watershed = nrm_pract_g)%>%
  view()

M2 <- cor(correlations_final2)

testRes2 <- cor.mtest(correlations_final2, conf.level = 0.95)

r = rbind(c('protect_water', 'nrm_soil_cover', 'protect_med', 'nrm_watershed'),
          c('nrm_soil_cover', 'protect_water', 'nrm_watershed', 'protect_med'))

corrplot(M2, method = 'number', p.mat = testRes2$p, tl.cex = 0.5, insig = 'blank', pch.cex = 0.8, number.cex = 0.5, diag = FALSE, is.corr = FALSE)%>%
  corrRect(namesMat = r)


```

#### Lasso regressions - starting with threats

A lasso regression takes one response variable and a whole load of potential indicator variables and finds which of them can actually be combined to predict the response.  I sometimes used this in reverse to find what outcomes could be predicted by one indicator.

```{r threats}

y <- final$threats

final_predict <- final%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("threat"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

cv_model <- cv.glmnet(x, y, alpha = 1)
best_lambda <- cv_model$lambda.min
plot(cv_model) 
best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)
coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

```

## Membership Analysis

I looked into group membership with a lasso regression and found several leads worth pursuing, detailed below.

#### Effects of membership in any group

```{r initial lasso regression}

# adding membership info into the most recent dataset

final_member <- final%>%
  mutate(across(member_ag:member_other2, ~replace_na(.,0)))

final_member<- final_member%>%
  mutate(threats_sum = rowSums(select(final_member, threats_illegal_logging:threats_resource_use), na.rm = TRUE), .after = threats_other_EN)%>%
  mutate(member_sum = rowSums(select(final_member, member_ag:member_other2)), .after = member_other2)%>%
  mutate(member_any = ifelse((member_sum>0), 1, 0))%>%
  mutate(probability_not_in_poverty = (100-ppi)/100, .after = ppi)%>%
  mutate(how_food_secure = 1-fies_unw_avg, .after = fies_unw_avg)

y <- final_member$member_any

final_predict <- final_member%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("member"), -probability_not_in_poverty, -how_food_secure)%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

cv_model <- cv.glmnet(x, y, alpha = 1)
best_lambda <- cv_model$lambda.min
plot(cv_model) 
best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)
coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

```

```{r starting to dive in with some plots}

final_member_compact <- final_member%>%
  select(member_sum, member_any, threats, threats_sum, protect_sum, nrm_pract_sum, trees_plant, loss, fies_unw_avg, how_food_secure, mddw, ppi, probability_not_in_poverty)%>%
  view()

final_member_compact %>%
  drop_na(.)%>%
  gather(threats, threats_sum, protect_sum, nrm_pract_sum, trees_plant, loss, fies_unw_avg, mddw, key = "var", value = "value") %>% 
  ggplot(aes(x = as_factor(member_any), fill = as_factor(value))) +
    geom_bar(position = 'fill') +
    facet_wrap(~ var, scales = "free") +
    theme_bw()

fact_names <- as_labeller(c("mddw" = "Women's minimum dietary diversity achieved", "trees_plant" = "Planted trees"))

final_member_compact %>%
  drop_na(.)%>%
  gather(mddw, trees_plant, key = "var", value = "value") %>% 
  ggplot(aes(x = as_factor(member_any), fill = as_factor(value))) +
    geom_bar(position = 'fill') +
    facet_wrap(~ var, scales = "free", labeller = fact_names) +
    scale_fill_brewer(palette = "Paired", name = "", labels = c("No", "Yes"))+
    labs(y = "Percent")+
    scale_y_continuous(labels = scales::percent)+
    theme_usaid()+
    scale_x_discrete(labels = c("Non-Member", "Member"), name = "")

final_member_compact %>%
  drop_na(.)%>%
  ggplot(aes(x = as_factor(member_any), fill = as_factor(trees_plant)))+
  geom_bar(position = 'fill')+
  theme_usaid()+
scale_y_continuous(labels = scales::percent)+
  labs(y = "Percent")+
  scale_x_discrete(labels = c("Non-Member", "Member"), name = "")+
  scale_fill_manual(values = c("#BA0C2F", "#002F6C"), name = "",
labels = c("Did not plant any trees in the last three years", "Planted trees in the last three years"))

final_member_compact %>%
  group_by(member_any)%>%
  summarize(trees_percent = mean(trees_plant, drop_na()))%>%
  ggplot(aes(x = as_factor(member_any), y = trees_percent))+
  geom_col(fill = "#002F6C")+
  theme_usaid()+
  coord_fixed(ratio = 4)+
  scale_y_continuous(labels = scales::percent)+
  labs(y = "")+
  scale_x_discrete(labels = c("Non-Member", "Member"), name = "")+
  labs(title = "Households That Planted Trees in the \nLast Three Years")

ggsave("trees_plant_graph.png", width = 5)

final_member_compact%>%
  drop_na(ppi)%>%
  ggplot(aes(x = as_factor(member_any))) +
    geom_violin(aes(y = ppi))+
    geom_violin(aes(y = fies_unw_avg))+
    theme_bw()

final_member%>%
  group_by(member_any)%>%
  filter(trees_plant == 1)%>%
  drop_na(trees_why_perm)%>%
  summarise(mean(trees_why_perm, drop.na = TRUE))

final_member%>%
  group_by(member_any)%>%
  filter(trees_plant == 1)%>%
  drop_na(trees_why_perm)%>%
  summarise(sum(trees_why_perm))

final_member%>%
  group_by(member_any)%>%
  filter(trees_plant == 1)%>%
  drop_na(trees_why_cut)%>%
  summarise(mean(trees_why_cut, drop.na = TRUE))

view(final_member)

```

```{r linear modeling to confirm significance}

summary(lm(threats ~ member_any, data = final_member))
summary(lm(threats_sum ~ member_any, data = final_member))
summary(lm(protect_sum ~ member_any, data = final_member))
summary(lm(nrm_pract_sum ~ member_any, data = final_member))
summary(lm(trees_plant ~ member_any, data = final_member))
#summary(lm(clear_where_a ~ member_any, data = final_member))
#summary(lm(clear_where_b ~ member_any, data = final_member))
#summary(lm(clear_where_c ~ member_any, data = final_member))
#summary(lm(clear_protect ~ member_any, data = final_member))
# the clear variables weren't as statistically significant as the rest (only one was significant at all)
summary(lm(loss ~ member_any, data = final_member))
summary(lm(fies_unw_avg ~ member_any, data = final_member))
summary(lm(ppi ~ member_any, data = final_member))
summary(lm(mddw ~ member_any, data = final_member))

```

```{r member_any corrplot}

final_member_predict <- final_member_compact%>%
  select(member_any, trees_plant, probability_not_in_poverty, how_food_secure, nrm_pract_sum, mddw, protect_sum, threats)%>%
  drop_na(mddw, probability_not_in_poverty, how_food_secure, nrm_pract_sum)%>%
  view()

MM <- cor(final_member_predict)

view(MM)

testResM <- cor.mtest(final_member_predict, conf.level = 0.95)

rownames(MM) <- c(" ", "Believe environment is under threat", "Perceived importance of ecosystem services", "Number of natural resource management practices used", "Whether they planted trees in last year", "How food secure they are (Reverse FIES)", "Whether minimum dietary diversity achieved (MDD-W)", "Probability they're not in poverty (Reverse PPI)")
colnames(MM) <- c(" ", "Believe environment is under threat", "Perceived importance of ecosystem services", "Number of natural resource management practices used", "Whether they planted trees in last year", "How food secure they are (Reverse FIES)", "Whether minimum dietary diversity achieved (MDD-W)", "Probability they're not in poverty (Reverse PPI)")

usaid_blue <- c("#86bbff", "#5ea4ff", "#0e77ff", "#002F6C", "#00214c")



png(height=400, width=500, file = "correlation_plot.png", type = "cairo")

corrplot(MM[2:8, 1, drop=FALSE], method = 'color', p.mat = testResM$p[2:8, 1, drop = FALSE], tl.cex = 1, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 1, pch.col = "white", number.cex = 0.8, is.corr = FALSE, cl.pos = 'r', cl.cex = 0.6, cl.ratio = 0.7, tl.col = "black", col = colorRampPalette(usaid_blue)(10), col.lim = c(.11, .22), tl.srt = 0, tl.offset = 3, mar=c(1,1,1,1), family = "Gill Sans MT")
title(main = "Correlations with Household Group Membership", family = "Gill Sans MT", sub = "Significance levels: *** 0.001, ** 0.01, * 0.05")

dev.off()

```

#### Are there specific groups that have more of an impact?

```{r group disaggregation}

member_groups <- final_member%>%
  full_join(credit)%>%
  select(starts_with("member_"), threats, protect_sum, nrm_pract_sum, trees_plant, fies_unw_avg, mddw, ppi, -member_sum, -member_any, -member_other, -member_other2)%>%
  mutate(across(starts_with("member_"), ~replace_na(., 0)))%>%
  drop_na()%>%
  view()

MG <- cor(member_groups)

testResMG <- cor.mtest(member_groups, conf.level = 0.95)

corrplot(MG[11:17, 1:10, drop=FALSE], method = 'color', p.mat = testResMG$p[11:17,1:10], tl.cex = 0.5, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.8, number.cex = 0.5, is.corr = FALSE, col = COL2('BrBG'), cl.pos = 'r', cl.cex = 0.3, tl.col = "black")

```

#### MDDW and Religion

In the chunk above, I found a strong correlation between MDDW and membership in a religious group, so I wanted to look into it further.

```{r MDDW-Religion}

final_member%>%
  filter(!is.na(mddw))%>%
  ggplot(aes(x = as_factor(member_religious), fill = as_factor(mddw)))+
  geom_bar(position = 'fill')+
  scale_fill_brewer(palette = "Paired", name = "", labels = c("Minimum Dietary Diversity (Women) Not Achieved", "Minimum Dietary Diversity (Women) Achieved"))+
  labs(title = "Minimum Dietary Diversity Achieved by Women in Household By Religious Affiliation Status", y = "Percent")+
  scale_y_continuous(labels = scales::percent)+
  theme_minimal()+
  theme(plot.title = element_text(size = 12))+
  scale_x_discrete(labels = c("Non-Religious", "Religious"), name = "")

# percent of members who achieved minimum dietary diversity
final_member%>%
  group_by(member_any)%>%
  summarise(mean(mddw, na.rm = TRUE), n())

# percent of religious members who achieved minimum dietary diversity
final_member%>%
  group_by(member_religious)%>%
  summarise(mean(mddw, na.rm = TRUE), n())

```

#### Does the number of groups matter?

```{r number groups corrplot}

y <- final_member$member_sum

final_predict <- final_member%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("member"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

cv_model <- cv.glmnet(x, y, alpha = 1)
best_lambda <- cv_model$lambda.min
plot(cv_model) 
best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)
coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

# nope. lasso looked largely the same
```

#### How does group membership affect poverty and the lived experience of it?

```{r fies-ppi plots}

final_member_compact%>%
  ggplot(aes(probability_not_in_poverty, how_food_secure, group = as_factor(member_any), color = as_factor(member_any)))+
  geom_smooth(method = 'lm', se = FALSE)+
#  geom_point()+
  scale_color_manual(values = c("#BA0C2F", "#002F6C"), name = "", labels = c("Not a Member", "Member of a Group"), guide = guide_legend(reverse = TRUE))+
  labs(title = "Correlation between Poverty Probability and Food Insecurity by Group Membership", x = "Probability Household Is Not in Poverty", y = "Level of Food Security (Reverse FIES Score)")+
  scale_x_continuous(labels = scales::percent)+
  theme_usaid()

final_member_compact%>%
  mutate(probability_not_in_poverty = (100-ppi)/100)%>%
  drop_na(mddw)%>%
  drop_na(probability_not_in_poverty)%>%
  ggplot(aes(as_factor(member_any), probability_not_in_poverty, color = as_factor(mddw), fill = as_factor(mddw)))+
  geom_dotplot(binaxis = "y", stackdir = "center")+
#  geom_point()+
  scale_fill_manual(values = c("#BA0C2F", "#002F6C"), name = "MDDW Achieved?", labels = c("No", "Yes"))+
  scale_color_manual(values = c("#BA0C2F", "#002F6C"), name = "MDDW Achieved?", labels = c("No", "Yes"))+
#  labs(title = "", x = "", y = "")+
  scale_y_continuous(labels = scales::percent)+
  theme_usaid()

final_member_compact%>%
  add_column(reproductive_females = tsiro_fm_data$reproductive_females)%>%
  group_by(member_any, mddw)%>%
  summarise(n = n())

final_member%>%
  select(-member_sum)%>%
  summarise(across(starts_with("member_"), ~sum(.x)))%>%
  pivot_longer(cols = everything(), names_to = "group", values_to = "count")%>%
  mutate(percent = count/754)%>%
  arrange(desc(count))

#mutual, trade not enough for statistical significance

```

#### A deeper dive in NRM practices by group membership status

```{r data set and linear modeling}

final_member_nrm <- final_member%>%
  mutate(nrm_pract_any = rowSums(select(final_member, nrm_pract_a:nrm_pract_g)))%>%
  mutate(nrm_pract_any = ifelse(nrm_pract_any > 0, 1, 0))

final_member_nrm%>%
  select(-nrm_pract_sum)%>%
  summarise(across(starts_with("nrm_pract_"), ~sum(.x, na.rm = TRUE)))%>%
  pivot_longer(cols = everything(), names_to = "group", values_to = "count")%>%
  mutate(percent = count/754)%>%
  arrange(desc(count))

summary(lm(nrm_pract_any ~ member_any, final_member_nrm))
summary(lm(nrm_pract_sum ~ member_any, final_member_nrm))

```

```{r nrm corrplot}

final_nrm_corrplot <- final_member_nrm %>%
  select(starts_with("nrm_pract_"), starts_with("member_"), -ends_with("sum"), -ends_with("any"))%>%
  replace(is.na(.), 0)

NRM <- cor(final_nrm_corrplot)

testResNRM <- cor.mtest(final_nrm_corrplot, conf.level = 0.95)

corrplot(NRM[9:18, 1:8, drop=FALSE], method = 'color', p.mat = testResNRM$p[9:18, 1:8], tl.cex = 0.5, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.8, number.cex = 0.5,  is.corr = FALSE, col = COL2('BrBG'), cl.pos = 'r', cl.cex = 0.3, tl.col = "black")

```

```{r perceptions vs. actions graph}

final_member%>%
  filter(protect_sum > -5)%>%
  ggplot(aes(protect_sum, nrm_pract_sum, color = as_factor(member_any)))+
  geom_smooth(method = 'lm', se = FALSE)+
  theme_usaid()+
  scale_color_manual(values = c("#BA0C2F", "#002F6C"), name = "", labels = c("Not a Member", "Member of a Group"),
                     guide = guide_legend(reverse = TRUE))+
  labs(title = "Relationship between Environmental Importance Perception \nand Natural Resource Management Practice Use by Group \nMembership", 
       x = "Perceived Importance of Ecosystem Services Score",
       y = "Number of Natural Resource Management Practices Used")

ggsave("nrm_environment.png")

```


```{r tree planting specifically}

# percent of members vs. non-members who planted trees
final_member%>%
  group_by(member_any)%>%
  summarise(mean(trees_plant, na.rm = TRUE), n())

```


```{r more miscellaneous statistics}

# average protect score for members vs. non-members
final_member%>%
  group_by(member_any)%>%
  summarise(mean(protect_sum, na.rm = TRUE), n())

# what percent of members vs. non-members think their environment is under threat
final_member%>%
  group_by(member_any)%>%
  summarise(mean(threats, na.rm = TRUE), n())

# is the correlation between membership and threat perception significant?
summary(lm(threats ~ member_any, final_member))

# average number of natural resource management practices used, members vs. non-members
final_member%>%
  group_by(member_any)%>%
  summarise(mean(nrm_pract_sum, na.rm = TRUE), n())

```


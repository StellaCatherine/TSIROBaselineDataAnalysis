---
title: "TSIRO Baseline Data Analysis"
author: "Stella Banino"
date: '2022-12-22'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(moderndive)
library(modelr)
library(haven)
library(purrr)
library(corrplot)
```

## Importing the data

```{r import}
setwd("C:/Users/scban/Documents/UVA/TSIROBaselineDataAnalysis")
tsiro_raw_data <- read_dta("TSIRO_baseline_public_gender.dta")
view(tsiro_raw_data)
```


## Breaking down and cleaning the dataset

Let's start by dividing the dataset into each separate module and making the sex columns easier to understand.

```{r}

tsiro_fm_data <- tsiro_raw_data%>%
  mutate_at(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), as.character)%>%
  mutate(across(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), str_replace, "1", "M"))%>%
  mutate(across(c("head_sex", "spouse_sex", "mod_b_respondent_sex", "mod_c_respondent_sex", "mod_d_respondent_sex", "mod_e_respondent_sex", "mod_f_respondent_sex", "mod_i_respondent_sex", "mod_h_respondent_sex", "mod_g_respondent_sex", "mod_c_wdd_respondent_sex"), str_replace, "2", "F"))
#glimpse(tsiro_raw_data)


roster <- select(tsiro_fm_data, hhid_deid, head_sex,spouse_sex,region,hhsize:read_head, fokontany_deid)
agriculture <- select(tsiro_fm_data, hhid_deid, mod_d_respondent_sex, plots:nrm_pract_y)
credit <- select(tsiro_fm_data, hhid_deid, mod_e_respondent_sex, loan_ngo:assist_inputs)
resources <- select(tsiro_fm_data, hhid_deid, mod_f_respondent_sex, trees:threats_other_EN)
energy <- select(tsiro_fm_data, hhid_deid, mod_g_respondent_sex, fuel_sources:fuel_dist1_3)
poverty <- select(tsiro_fm_data, hhid_deid, mod_i_respondent_sex, tv:detergent, birth, children_5_18)
foodsec <- select(tsiro_fm_data, hhid_deid, mod_c_respondent_sex, mod_c_wdd_respondent_sex, fies_enough:mddw)
empower <- select(tsiro_fm_data, hhid_deid, head_sex,spouse_sex, mod_h_respondent_sex, partner:alone)

# view(roster)
# view(agriculture)
# view(credit)
# view(resources)
# view(energy)
# view(poverty)
# view(foodsec)
# view(empower)
```


#### Views on the environment score

```{r}
# glimpse(resources)
resources_views <- resources%>%
  rename(protect = protect_label)%>%
  mutate(across(starts_with("protect_"), ~ .x - 3))
# formatting so operations are easier

resources_views <- resources_views %>%
  mutate(protect_avg = rowMeans(select(resources_views, starts_with("protect_")), na.rm = TRUE), .after = protect_med)%>%
  mutate(protect_sum = protect_avg*8)
# Calculating priority indicator "Average score measuring the perceived
# importance of protecting nature and the environment".
# Asks about the importance of 8 ecosystem services relevant to this population.

resources_views <- resources_views %>%
  rename("threats_illegal_logging" = "threats_big_a",
         "threats_slash_burn" = "threats_big_b",
         "threats_poaching" = "threats_big_c",
         "threats_wildlife_trafficking" = "threats_big_d",
         "threats_seine_fishing" = "threats_big_e",
         "threats_fishing_other" = "threats_big_f",
         "threats_climate_change" = "threats_big_g",
         "threats_farming" = "threats_big_h",
         "threats_resource_use" = "threats_big_i")

resources_trees <- resources_views%>%
  mutate(trees_why_perm = ifelse((trees_why_a == 1 |
                                    trees_why_e == 1 |
                                    trees_why_f == 1 |
                                    trees_why_i == 1 |
                                    trees_why_j == 1), 1, 0),
         trees_why_cut = ifelse((trees_why_b == 1 |
                                   trees_why_c == 1 |
                                   trees_why_d == 1 |
                                   trees_why_g == 1 |
                                   trees_why_h == 1 |
                                   trees_why_b == 1), 1, 0), .after = trees_other_EN)

```

I want to look more at unsustainable resource use.  The toolkit says each activity should pick unsustainable practices to look at, so here's a list of what TSIRO collected that I think I could use:
collection of forest products
plans to clear land next year
cleared land last year

do you engage in this activity?
why?
how important is it to you?
how often do you do it?
has this changed over the past year (if so, why)?
perception of ecosystem status in the future? (could take this from threats data)
who makes decisions on engaging in the activity and who engages most in the activity can be disaggregated by gender

Primary indicator here is whether the households engage in the activity, other stuff is just for added context

#### Calculating FIES Percentage

```{r}
# view(foodsec)
#code modified from FAO Voices of the Hungry project report, attached.

foodsec_fies <- foodsec%>%
  mutate(fies_unw_avg = rowMeans(select(foodsec, starts_with("fies_")), na.rm = TRUE), .after = fies_day)
```

#### Calculating PPI

```{r}
view(poverty)

poverty_ppi <- poverty%>%
  mutate(soap_water = as.numeric(water == 1 & (detergent == 1 | detergent == 2)),
         soap_4k = as.numeric(soap > 4000))%>%
  mutate(ppi = (77)*1 + (-13)*food_1 + (-13)*tv + (-12)*food_2 + (-7)*food_3
					+ (-5)*clothes_1 + (-4)*linen_2 + (4)*food_5 + (-4)*clothes_2
					+ (4)*birth + (-4)*food_4 + (-3)*clothes_3
					+ (-3)*soap_water + (-3)*shoes + (2)*children_5_18 + (-2)*linen_1
					+ (-1)*soap_4k + (-1)*roofmat)%>%
  view()

summarise(poverty_ppi, across(everything(), ~ sum(is.na(.x))))

```

## Creating narrow dataset

Okay first planning - what do I want in here, section by section?

#### roster

hhid_deid
spouse_sex
gender_hh_type

#### agriculture

hhid_deid
nrm_pract:nrm_pract_g

#### credit

#### resources_views

hhid_deid
mod_f_respondent_sex
trees_plant:trees_other_EN
land_kind_a           did you clear forest for cultivation
clear_where_a         plan to clear land for cultivation
clear_protect         plan to clear protected area
honey, mush, insects, fruits, meat, plants, woods, char, fish     how important are each of these to your livelihood
protect_water:loss_affect   importance of protecting each, have you lost resources, how were you affected?
threats:threat_big_i

#### energy

hhid_deid
starts_with(fuel_sources), starts_with(fuel_men), starts_with(fuel_women) what fuel sources do you use and who spends how much time gathering them

I'm going to want to sum fuel_men variables and fuel_women variables, but might do that after join.

#### poverty

hhid_deid
ppi

#### foodsec_fies

hhid_deid
fies_enough:fies_unw_avg        fies info
CSI         coping strategies index score
birth       has anyone given birth in this household
mddw        minimum dietary diversity - women

#### empower

hhid_deid 

```{r}
# glimpse(roster)
# glimpse(agriculture)
# glimpse(credit)
# glimpse(resources_views)
# glimpse(energy)
# glimpse(poverty)
# glimpse(foodsec)
# glimpse(empower_real)

roster_merge <- roster%>%
  select(hhid_deid, head_sex, spouse_sex, gender_hh_type:fokontany_deid)
agriculture_merge <- agriculture%>%
  select(hhid_deid, nrm_pract_a:nrm_pract_y)
credit_merge <- credit%>%
  select(hhid_deid, loan_ngo, loan_informal, loan_formal, loan_friend, loan_group, loan_sav, starts_with("member_"))
resources_merge <- resources_trees
energy_merge <- energy%>%
  select(hhid_deid, starts_with("fuel_sources"), starts_with("fuel_men"), starts_with("fuel_women"))
poverty_merge <- poverty_ppi%>%
  select(hhid_deid, ppi)
foodsec_merge <- foodsec_fies%>%
  select(hhid_deid, fies_enough:fies_unw_avg, CSI, birth, mddw)

final <- reduce(list(roster_merge, agriculture_merge, credit_merge, resources_merge, energy_merge, poverty_merge, foodsec_merge), full_join, by = "hhid_deid")%>%
  # how many natural resource management practices is this household using?
  mutate(nrm_pract_sum = rowSums(select(agriculture_merge, nrm_pract_a:nrm_pract_y)), .after = nrm_pract_g)%>%
  # how many hours are men vs. women spending collecting fuel
  mutate(across(fuel_men_1:fuel_women_6), replace_na(0))%>%
  mutate(fuel_men_hours = rowSums(select(energy_merge, fuel_men_1:fuel_men_6), na.rm = TRUE), .after= fuel_women_6)%>%
  mutate(fuel_women_hours = rowSums(select(energy_merge, fuel_women_1:fuel_women_6), na.rm = TRUE), .after = fuel_men_hours)

```
## Analysis

#### Creating USAID ggplot theme

```{r}
theme_usaid <- function(){ 
    font <- "Gill Sans MT"
    theme_minimal() %+replace%
    theme(
      #grid elements
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.ticks = element_blank(),
      #text elements
      plot.title = element_text(family = font, size = 20, hjust = 0, vjust = 2),
      plot.subtitle = element_text(family = font, size = 14),
      plot.caption = element_text(family = font, size = 9, hjust = 1),
      axis.title = element_text(family = font, size = 10),
      axis.text = element_text(family = font, size = 9),
      axis.text.x = element_text(margin=margin(5, b = 10))
    )
}
```

#### Initial poking around

```{r}

final%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(protect_water:protect_avg, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(protect_water:protect_avg, names_to = "protect_resource", names_prefix = "protect_")%>%
  ggplot(aes(protect_resource, value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")

# this looks at average scores on a five-point scale.  What about just a blanket
# do you think this resource is important or not?

final%>%
  mutate(yn_protect_water = ifelse(protect_water > 0, 1, 0),
         yn_protect_air = ifelse(protect_water > 0, 1, 0),
         yn_protect_soil = ifelse(protect_water > 0, 1, 0),
         yn_protect_comm = ifelse(protect_water > 0, 1, 0),
         yn_protect_raw = ifelse(protect_water > 0, 1, 0),
         yn_protect_plants = ifelse(protect_water > 0, 1, 0),
         yn_protect_dis = ifelse(protect_water > 0, 1, 0),
         yn_protect_med = ifelse(protect_water > 0, 1, 0),
         .after = protect_avg)%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(yn_protect_water:yn_protect_med, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(yn_protect_air:yn_protect_med, names_to = "yn_protect_resource", names_prefix = "yn_protect_")%>%
  ggplot(aes(fct_rev(fct_reorder(yn_protect_resource, value)), value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")+
  scale_y_continuous(labels = scales::percent)+
  guides(x = guide_axis(angle = 45))+
  labs(title = "Percent of Men and Women who Believe Ecosystem Services are Important to Protect...",
       x = "Resource",
       y = "Percent")

final%>%
  group_by(mod_f_respondent_sex)%>%
  summarise(across(threats_illegal_logging:threats_resource_use, ~ (mean(.x, na.rm = TRUE))))%>%
  pivot_longer(threats_illegal_logging:threats_resource_use, names_to = "threat_type", names_prefix = "threats_")%>%
  ggplot(aes(fct_rev(fct_reorder(threat_type, value)), value, group = mod_f_respondent_sex))+
  geom_col(aes(fill = mod_f_respondent_sex), position = "dodge")+
  scale_y_continuous(labels = scales::percent)+
  guides(x = guide_axis(angle = 45))+
  labs(title = "Percent of Men and Women who Believe Their Ecosystem Is Threatened By...",
       x = "Threat Type",
       y = "Percent")

# The greatest gap seems to be concern over firewood.  Out of curiosity...
summarise(final, across(c(fuel_men_3, fuel_women_3), ~ (mean(.x, na.rm = TRUE))))
# On average, men spend VASTLY more time collecting firewood than women.  Maybe
# that's why they're more concerned about the impact of illegal logging.

final%>%
  mutate(loss = as.factor(loss))%>%
  ggplot(aes(protect_avg))+
  geom_density(aes(color = loss), size = 1)+
  scale_color_brewer(palette = "Paired")

final%>%
  drop_na(nrm_pract_sum)%>%
  mutate(nrm_pract_sum = as.factor(nrm_pract_sum))%>%
  ggplot(aes(protect_avg))+
  geom_density(aes(color = nrm_pract_sum))+
  facet_grid(cols = vars(nrm_pract_sum))

final%>%
  drop_na(nrm_pract_sum)%>%
  mutate(nrm_pract_sum = as.factor(nrm_pract_sum))%>%
  ggplot(aes(protect_avg))+
  geom_density(aes(color = nrm_pract_sum))+
  facet_grid(cols = vars(nrm_pract_sum))
  

```


hm.  This is the first time I've gotten a good look at the roster and I'm
looking through the gender hh type and noticing that it doesn't always align
with the recorded head_sex/spouse_sex.  Is the spouse not living at home?  Either
way, this adds another layer of difficulty to my assumption that I can figure out
the gender of a respondent's partner based on this data.  I might just have to
take out any data that required me to assume the gender of the respondent's partner -
or the presence of a partner at all.


Ok questions for 1/12 meeting:
- going to need child_6_11 to accurately calculate PPI.  Would that need IRB approval?  If so, that's not going to get to me in time.
- for any of the you or your partner stuff to be helpful, I think we need to know if they're the head of the household for two reasons:
1. we don't know their marital status/spouse of their partner unless we have that
  a. based on the numbers that less than 1% of HoH couples are same-sex I don't mind assuming all unknown spouses are straight, but for the credit section, I don't even know if they have a partner
2. in the empowerment section we do know whether they have a partner, but we're missing a crucial aspect of their decision making power if we don't know whether they're in the HoH couple.  If I answered the door, I would say I'm not on the deed, but that doesn't mean women have less power in my household, it just means I'm not in the HoH couple

#### looking for stuff that correlates with several unsustainable activities
```{r}

final_agriculture <- full_join(final, agriculture, by = "hhid_deid")

final_agriculture <- final_agriculture%>%
  mutate(across(c("clear_where_a", "clear_where_c", "land_kind_a", "land_kind_c"), ~replace_na(.,0)))%>%
  mutate(clear_any = clear_where_a+clear_where_c+land_kind_a+land_kind_c)%>%
  mutate(clear_any = ifelse(clear_any > 0, 1, 0))%>%
  view()

final_agriculture%>%
  group_by(clear_any)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(clear_any)))+
  geom_bar()+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
  filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  group_by(clear_any)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(clear_any)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
    filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  group_by(collect)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(collect)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
    filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  drop_na(loss)%>%
  group_by(loss)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(loss)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
    filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  drop_na(threats_big)%>%
  group_by(threats_big)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(threats_big)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

final_agriculture%>%
    filter(crops_1 == 1 |
           crops_1 == 2 |
           crops_1 == 6 |
           crops_1 == 7 |
           crops_1 == 13 |
           crops_1 == 14)%>%
  drop_na(ppi)%>%
  group_by(ppi)%>%
  ggplot(aes(as_factor(crops_1), fill = as_factor(ppi)))+
  geom_bar(position = "fill")+
  guides(x = guide_axis(angle = 45))

#obviously not the best chart type for this, but wildly, you can see which crop-
#growers tend to be more and less wealthy.  Cassava growers aren't doing so hot.


# I feel like I'm trying to get a sense of a forest by staring at the bark of a
# single tree.

```
#### trees

I'm really loving the irony that I used a platitude about not seeing the forest at the beginning of this pivot, and then that's ACTUALLY what I was missing

```{r}

final%>%
  drop_na(threats_illegal_logging, wood_access)%>%
  ggplot(aes(as_factor(wood_access), fill = as_factor(threats_illegal_logging)))+
  geom_bar(position = "fill")

final%>%
  group_by(wood_access)%>%
  summarise(mean(threats_illegal_logging, na.rm = TRUE))

#ANOVA significance tests
summary(lm(wood_access ~ threats_illegal_logging, data = final))
# correlation between whether they've had trouble getting wood and whether they think the environment is threatened by illegal logging 
summary(lm(wood ~ threats_illegal_logging, data = final))
# no correlation between how important wood is to their livelihood and whether they think the environment is threatened by illegal logging
summary(lm(trees_plant ~ threats_illegal_logging, data = final))
# positive correlation
summary(lm(trees_why_perm ~ threats_illegal_logging, data = final))
# positive correlation
summary(lm(trees_why_cut ~ threats_illegal_logging, data = final))
# no significant correlation
summary(lm(wood_access ~ clear_where_a, data = final))
# no significant correlation between difficulty collecting firewood and plans to clear forest
summary(lm(clear_where_a ~ threats_illegal_logging, data = final))
# absolutely no correlation between threat of illegal logging and plan to clear land

```
#### Corrplots
```{r}
correlations_final <- final%>%
  mutate(member_sum = rowSums(select(final, member_ag:member_other2), na.rm = TRUE), .after = member_other2)%>%
  select(nrm_pract_a:nrm_pract_g, member_ag:member_women)%>%
  replace(is.na(.), 0)%>%
  rename(nrm_soil_cover = nrm_pract_a,
         nrm_soil_fertility = nrm_pract_b,
         nrm_agroforestry = nrm_pract_c,
         nrm_fire_prevent = nrm_pract_d,
         nrm_water = nrm_pract_e,
         nrm_erosion_control = nrm_pract_f,
         nrm_watershed = nrm_pract_g)%>%
  view()

M <- cor(correlations_final)

testRes <- cor.mtest(correlations_final, conf.level = 0.95)

corrplot(M, method = 'number', p.mat = testRes$p, tl.cex = 0.5, insig = 'blank', pch.cex = 0.8, pch.col = 'grey20', number.cex = 0.5, diag = FALSE, type = 'lower', is.corr = FALSE)
# members of agriculture groups were more likely to engage in natural resource managment practices than those who aren't.


correlations_final2 <- final%>%
  select(nrm_pract_a:nrm_pract_g, protect_water:protect_med)%>%
  replace(is.na(.), 0)%>%
  rename(nrm_soil_cover = nrm_pract_a,
         nrm_soil_fertility = nrm_pract_b,
         nrm_agroforestry = nrm_pract_c,
         nrm_fire_prevent = nrm_pract_d,
         nrm_water = nrm_pract_e,
         nrm_erosion_control = nrm_pract_f,
         nrm_watershed = nrm_pract_g)%>%
  view()

M2 <- cor(correlations_final2)

testRes2 <- cor.mtest(correlations_final2, conf.level = 0.95)

r = rbind(c('protect_water', 'nrm_soil_cover', 'protect_med', 'nrm_watershed'),
          c('nrm_soil_cover', 'protect_water', 'nrm_watershed', 'protect_med'))

corrplot(M2, method = 'number', p.mat = testRes2$p, tl.cex = 0.5, insig = 'blank', pch.cex = 0.8, number.cex = 0.5, diag = FALSE, is.corr = FALSE)%>%
  corrRect(namesMat = r)


```

```{r}
final_gap <- final%>%
  group_by(fokontany_deid)%>%
  summarise(mean_gap = mean(protect_sum, na.rm = TRUE) - mean(nrm_pract_sum, na.rm = TRUE), mean_ppi = mean(ppi, na.rm = TRUE))

summary(lm(mean_gap ~ mean_ppi, data = final_gap))

final_gap_hh <- final%>%
  mutate(gap = protect_sum - nrm_pract_sum - trees_plant)%>%
  drop_na(gap)

#define response variable
y <- final_gap_hh$gap

#define matrix of predictor variables
final_predict <- final_gap_hh%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("nrm"), -starts_with("protect"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

library(glmnet)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min
best_lambda

#produce plot of test MSE by lambda value
plot(cv_model) 


best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq





#define response variable
y <- final_gap_hh$threats

#define matrix of predictor variables
final_predict <- final_gap_hh%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("threat"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

library(glmnet)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min

#produce plot of test MSE by lambda value
plot(cv_model) 

best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq

```

#### Membership
```{r member of any group}
# adding membership info into the most recent dataset

final_member <- final%>%
  mutate(across(member_ag:member_other2, ~replace_na(.,0)))

final_member<- final_member%>%
  mutate(threats_sum = rowSums(select(final_member, threats_illegal_logging:threats_resource_use), na.rm = TRUE), .after = threats_other_EN)%>%
  mutate(member_sum = rowSums(select(final_member, member_ag:member_other2)), .after = member_other2)%>%
  mutate(member_any = ifelse((member_sum>0), 1, 0))

#define response variable
y <- final_member$member_any

#define matrix of predictor variables
final_predict <- final_member%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("member"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min

#produce plot of test MSE by lambda value
plot(cv_model) 

best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq


final_member_compact <- final_member%>%
  select(member_sum, member_any, threats, threats_sum, protect_sum, nrm_pract_sum, trees_plant, loss, fies_unw_avg, mddw, ppi)%>%
  view()

final_member_compact %>%
  drop_na(.)%>%
  gather(threats, threats_sum, protect_sum, nrm_pract_sum, trees_plant, loss, fies_unw_avg, mddw, key = "var", value = "value") %>% 
  ggplot(aes(x = as_factor(member_any), fill = as_factor(value))) +
    geom_bar(position = 'fill') +
    facet_wrap(~ var, scales = "free") +
    theme_bw()

fact_names <- as_labeller(c("mddw" = "Women's minimum dietary diversity achieved", "trees_plant" = "Planted trees"))

final_member_compact %>%
  drop_na(.)%>%
  gather(mddw, trees_plant, key = "var", value = "value") %>% 
  ggplot(aes(x = as_factor(member_any), fill = as_factor(value))) +
    geom_bar(position = 'fill') +
    facet_wrap(~ var, scales = "free", labeller = fact_names) +
    scale_fill_brewer(palette = "Paired", name = "", labels = c("No", "Yes"))+
    labs(y = "Percent")+
    scale_y_continuous(labels = scales::percent)+
    theme_usaid()+
    scale_x_discrete(labels = c("Non-Member", "Member"), name = "")

final_member_compact%>%
  drop_na(ppi)%>%
  ggplot(aes(x = as_factor(member_any))) +
    geom_violin(aes(y = ppi))+
    geom_violin(aes(y = fies_unw_avg))+
    theme_bw()
  

summary(lm(threats ~ member_any, data = final_member))
summary(lm(threats_sum ~ member_any, data = final_member))
summary(lm(protect_sum ~ member_any, data = final_member))
summary(lm(nrm_pract_sum ~ member_any, data = final_member))
summary(lm(trees_plant ~ member_any, data = final_member))
#summary(lm(clear_where_a ~ member_any, data = final_member))
#summary(lm(clear_where_b ~ member_any, data = final_member))
#summary(lm(clear_where_c ~ member_any, data = final_member))
#summary(lm(clear_protect ~ member_any, data = final_member))
# the clear variables weren't as statistically significant as the rest (only one was significant at all)
summary(lm(loss ~ member_any, data = final_member))
summary(lm(fies_unw_avg ~ member_any, data = final_member))
summary(lm(ppi ~ member_any, data = final_member))
summary(lm(mddw ~ member_any, data = final_member))

final_member_predict <- final_member_compact%>%
  select(-member_sum, -threats_sum, -loss)%>%
  drop_na(ppi, mddw)

MM <- cor(final_member_predict)

testResM <- cor.mtest(final_member_predict, conf.level = 0.95)

view(MM)

rownames(MM) <- c("Whether they're a member of a group", "Believes environment is threatened", "How important they believe ecosystem services are", "How many natural resource management strategies they use", "Whether they've planted any trees recently", "How food insecure they are (FIES)", "Whether the women have achieved minimum dietary diversity (MDD-W)", "Probability they're in poverty (PPI)")
colnames(MM) <- c("Whether they're a member of a group", "Believes environment is threatened", "How important they believe ecosystem services are", "How many natural resource management strategies they use", "Whether they've planted any trees recently", "How food insecure they are (FIES)", "Whether the women have achieved minimum dietary diversity (MDD-W)", "Probability they're in poverty (PPI)")

corrplot(MM, method = 'color', p.mat = testResM$p, tl.cex = 0.5, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.8, number.cex = 0.5, diag = FALSE, is.corr = FALSE, type = 'lower', col = COL2('BrBG'), cl.pos = 'r', cl.cex = 0.3, tl.col = "black")

view(final_member_compact)
```

```{r group disaggregation}

member_groups <- final_member%>%
  full_join(credit)%>%
  select(starts_with("member_"), threats, protect_sum, nrm_pract_sum, trees_plant, fies_unw_avg, mddw, ppi, -member_sum, -member_any, -member_other, -member_other2)%>%
  mutate(across(starts_with("member_"), ~replace_na(., 0)))%>%
  drop_na()%>%
  view()
           
# we end up with 24 fokontanies.

MG <- cor(member_groups)

testResMG <- cor.mtest(member_groups, conf.level = 0.95)

corrplot(MG[11:17, 1:10, drop=FALSE], method = 'color', p.mat = testResMG$p[11:17,1:10], tl.cex = 0.5, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.8, number.cex = 0.5, is.corr = FALSE, col = COL2('BrBG'), cl.pos = 'r', cl.cex = 0.3, tl.col = "black")


```

```{r does the number of groups matter?}
#define response variable
y <- final_member$member_sum

#define matrix of predictor variables
final_predict <- final_member%>%
  select(gender_hh_type:member_other2, trees_a:trees_y, trees_why_a:trees_why_k, trees_why_perm:land, land_kind_a:land_kind_b, clear, clear_why_a:clear_why_z, clear_where_a:clear_where_z, clear_protect:honey_why, mush:mush_why, insects:insects_why, fruits:fruits_why, meat:meat_why, plants:plants_why, fish:fish_why, wood:wood_why, char:char_why, protect_water:loss, threats, threats_illegal_logging:threats_resource_use, fuel_sources_1:fuel_sources_6, fuel_sources2_1:fuel_women_hours, ppi:mddw, -starts_with("member"))%>%
  replace(is.na(.), 0)%>%
  na.omit(.)
x <- data.matrix(final_predict)

#perform k-fold cross-validation to find optimal lambda value
cv_model <- cv.glmnet(x, y, alpha = 1)

#find optimal lambda value that minimizes test MSE
best_lambda <- cv_model$lambda.min

#produce plot of test MSE by lambda value
plot(cv_model) 

best_model <- glmnet(x, y, alpha = 1, lambda = best_lambda)

coef(best_model)

as.data.frame(as.matrix(coef(best_model)))%>%
  arrange(desc(s0))

#use fitted best model to make predictions
y_predicted <- predict(best_model, s = best_lambda, newx = x)

#find SST and SSE
sst <- sum((y - mean(y))^2)
sse <- sum((y_predicted - y)^2)

#find R-Squared
rsq <- 1 - sse/sst
rsq

# nope.
```

```{r fies-ppi}

final_member_compact%>%
  mutate(probability_not_in_poverty = (100-ppi)/100)%>%
  rename(how_food_insecure = fies_unw_avg)%>%
  ggplot(aes(probability_not_in_poverty, how_food_insecure, group = as_factor(member_any), color = as_factor(member_any)))+
  geom_smooth(method = 'lm')+
#  geom_point()+
  scale_color_manual(values = c("#0C7C59", "#22AED1"), name = "Group Member?", labels = c("No", "Yes"))+
  labs(title = "Correlation between Poverty Probability and Food Insecurity by Group Membership", x = "Probability Household Is Not in Poverty", y = "Food Insecurity Experience Score")+
  scale_x_continuous(labels = scales::percent)

final_member_compact%>%
  mutate(probability_not_in_poverty = (100-ppi)/100)%>%
  drop_na(mddw)%>%
  drop_na(probability_not_in_poverty)%>%
  ggplot(aes(as_factor(member_any), probability_not_in_poverty, color = as_factor(mddw), fill = as_factor(mddw)))+
  geom_dotplot(binaxis = "y", stackdir = "center")+
#  geom_point()+
  scale_fill_manual(values = c("#0C7C59", "#22AED1"), name = "MDDW Achieved?", labels = c("No", "Yes"))+
  scale_color_manual(values = c("#0C7C59", "#22AED1"), name = "MDDW Achieved?", labels = c("No", "Yes"))+
#  labs(title = "", x = "", y = "")+
  scale_y_continuous(labels = scales::percent)

final_member_compact%>%
  add_column(reproductive_females = tsiro_fm_data$reproductive_females)%>%
  group_by(member_any, mddw)%>%
  summarise(n = n())

final_member%>%
  select(-member_sum)%>%
  summarise(across(starts_with("member_"), ~sum(.x)))%>%
  pivot_longer(cols = everything(), names_to = "group", values_to = "count")%>%
  mutate(percent = count/754)%>%
  arrange(desc(count))

#mutual, trade not enough for statistical significance

```

```{r MDDW-Religion}

final_member%>%
  filter(!is.na(mddw))%>%
  ggplot(aes(x = as_factor(member_religious), fill = as_factor(mddw)))+
  geom_bar(position = 'fill')+
  scale_fill_brewer(palette = "Paired", name = "", labels = c("Minimum Dietary Diversity (Women) Not Achieved", "Minimum Dietary Diversity (Women) Achieved"))+
  labs(title = "Minimum Dietary Diversity Achieved by Women in Household By Religious Affiliation Status", y = "Percent")+
  scale_y_continuous(labels = scales::percent)+
  theme_minimal()+
  theme(plot.title = element_text(size = 12))+
  scale_x_discrete(labels = c("Non-Religious", "Religious"), name = "")

final_member%>%
  group_by(member_any, mddw)%>%
  summarise(n())
```

```{r nrm look}

final_member_nrm <- final_member%>%
  mutate(nrm_pract_any = rowSums(select(final_member, nrm_pract_a:nrm_pract_g)))%>%
  mutate(nrm_pract_any = ifelse(nrm_pract_any > 0, 1, 0))

final_member_nrm%>%
  select(-nrm_pract_sum)%>%
  summarise(across(starts_with("nrm_pract_"), ~sum(.x, na.rm = TRUE)))%>%
  pivot_longer(cols = everything(), names_to = "group", values_to = "count")%>%
  mutate(percent = count/754)%>%
  arrange(desc(count))

summary(lm(nrm_pract_any ~ member_any, final_member_nrm))
summary(lm(nrm_pract_sum ~ member_any, final_member_nrm))

final_nrm_corrplot <- final_member_nrm %>%
  select(starts_with("nrm_pract_"), starts_with("member_"), -ends_with("sum"), -ends_with("any"))%>%
  replace(is.na(.), 0)

NRM <- cor(final_nrm_corrplot)

testResNRM <- cor.mtest(final_nrm_corrplot, conf.level = 0.95)

corrplot(NRM[9:18, 1:8, drop=FALSE], method = 'color', p.mat = testResNRM$p[9:18, 1:8], tl.cex = 0.5, insig = 'label_sig', sig.level = c(0.001, 0.01, 0.05), pch.cex = 0.8, number.cex = 0.5,  is.corr = FALSE, col = COL2('BrBG'), cl.pos = 'r', cl.cex = 0.3, tl.col = "black")

```

```{r scratch work on final article}
final_member%>%
  group_by(member_any)%>%
  summarise(mean(protect_sum, na.rm = TRUE), n())

final_member%>%
  group_by(member_any)%>%
  summarise(mean(threats, na.rm = TRUE), n())

final_member%>%
  group_by(member_any)%>%
  summarise(mean(nrm_pract_sum, na.rm = TRUE), n())

final_member%>%
  filter(protect_sum > -5)%>%
  ggplot(aes(protect_sum, nrm_pract_sum, fill = as_factor(member_any), color = as_factor(member_any)))+
#  geom_point(position = 'jitter')+
  geom_smooth(method = 'lm')


final_member%>%
  group_by(member_any)%>%
  summarise(mean(mddw, na.rm = TRUE), n())

final_member%>%
  group_by(member_religious)%>%
  summarise(mean(mddw, na.rm = TRUE), n())

```

